{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Welcome, {{ user.name }}!</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('view_cart') }}" class="btn btn-primary me-2">
                View Cart 
                <span class="badge bg-light text-dark" id="cart-count">
                    {{ cart|length }}
                </span>
            </a>
            <a href="{{ url_for('labor_logout') }}" class="btn btn-outline-danger">Logout</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search products...">
                <select id="categoryFilter" class="form-select" style="max-width: 200px;">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row" id="productsGrid">
        {% for product in products %}
        <div class="col-md-4 mb-4 product-card" 
             data-category="{{ product.category }}"
             data-name="{{ product.name }}">
                            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text">Category: {{ product.category }}</p>
                    <div id="variants-container-{{ product._id }}">
                        {% for variant in product.variants %}
                        <div class="variant-row mb-3 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="variant-info">
                                    {{ variant.quantity }} - ${{ variant.price }}
                                    <small class="text-muted">({{ variant.stock }} in stock)</small>
                                </span>
                                <div class="form-check">
                                    <input class="form-check-input variant-checkbox" 
                                           type="checkbox" 
                                           value="{{ loop.index0 }}"
                                           id="variant-check-{{ product._id }}-{{ loop.index0 }}"
                                           data-product-id="{{ product._id }}"
                                           data-variant-index="{{ loop.index0 }}"
                                           data-price="{{ variant.price }}"
                                           data-quantity-type="{{ variant.quantity }}"
                                           data-stock="{{ variant.stock }}"
                                           {% if variant.stock <= 0 %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="quantity-input-group" style="display: none;">
                                <div class="input-group">
                                    <span class="input-group-text">Qty:</span>
                                    <input type="number" 
                                           class="form-control variant-quantity" 
                                           min="1"
                                           max="{{ variant.stock }}"
                                           value="1"
                                           data-variant-index="{{ loop.index0 }}"
                                           {% if variant.stock <= 0 %}disabled{% endif %}>
                                    <span class="input-group-text">Total: $<span class="variant-total">{{ variant.price }}</span></span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Total Selected: <span class="product-total-price">$0.00</span></span>
                        <button class="btn btn-primary add-to-cart-btn" 
                                data-product-id="{{ product._id }}"
                                data-product-name="{{ product.name }}">
                            Add Selected to Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize category filter
    const categories = new Set();
    document.querySelectorAll('.product-card').forEach(card => {
        categories.add(card.dataset.category);
    });

    const categoryFilter = document.getElementById('categoryFilter');
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });

    // Filter function
    function filterProducts() {
        const selectedCategory = categoryFilter.value.toLowerCase();
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        document.querySelectorAll('.product-card').forEach(card => {
            const category = card.dataset.category.toLowerCase();
            const name = card.dataset.name.toLowerCase();
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesSearch = !searchTerm || name.includes(searchTerm);
            
            card.style.display = matchesCategory && matchesSearch ? '' : 'none';
        });
    }

    // Add event listeners
    categoryFilter.addEventListener('change', filterProducts);
    document.getElementById('searchInput').addEventListener('input', filterProducts);

    // Add to Cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            
            const variantSelect = document.getElementById(`variant-${productId}`);
            const quantityInput = document.getElementById(`quantity-${productId}`);
            
            if (!variantSelect) {
                alert('Please select a product variant');
                return;
            }

            const variantIndex = parseInt(variantSelect.value);
            const selectedOption = variantSelect.options[variantSelect.selectedIndex];
            const quantity = parseInt(quantityInput.value);

            if (quantity < 1) {
                alert('Please select a valid quantity');
                return;
            }

            // Check if we have enough stock
            const stock = parseInt(selectedOption.dataset.stock);
            if (quantity > stock) {
                alert(`Sorry, only ${stock} items available in stock`);
                return;
            }

            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        variant_index: variantIndex,
                        quantity: quantity
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // Update cart count
                    const cartCount = document.getElementById('cart-count');
                    cartCount.textContent = parseInt(cartCount.textContent || 0) + 1;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error adding to cart: ' + error);
            }
        });
    });
});</script>
{% endblock %}