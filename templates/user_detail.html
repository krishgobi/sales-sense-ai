{% extends "base.html" %}

{% block title %}User Details - {{ user.name }}{% endblock %}

{% block content %}
<div class="container" style="max-width:1100px;">

  <!-- BB-style header -->
  <div style="background:#fff;border-radius:8px;padding:16px 20px;margin-bottom:20px;box-shadow:0 1px 4px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;">
    <div>
      <a href="{{ url_for('admin_dashboard') }}" style="color:#84C225;font-size:.85rem;font-weight:600;text-decoration:none;"><i class="fas fa-arrow-left me-1"></i>Back to Dashboard</a>
      <h2 style="font-size:1.2rem;font-weight:800;margin:4px 0 0;color:#333;"><i class="fas fa-user me-2" style="color:#84C225;"></i>{{ user.name }}</h2>
      <div style="font-size:.78rem;color:#888;">{{ user.email }} {% if user.mobile or user.phone %}&bull; {{ user.mobile or user.phone }}{% endif %}</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm" style="background:#fff;border:1.5px solid #84C225;color:#3d7a00;font-weight:600;" onclick="exportUserPDF('{{ user._id }}')">
        <i class="fas fa-file-pdf me-1"></i>Export PDF
      </button>
      <button class="btn btn-sm" style="background:#84C225;color:#fff;border:none;font-weight:600;" onclick="sendMarketingEmail('{{ user._id }}')">
        <i class="fas fa-envelope me-1"></i>Send Email
      </button>
    </div>
  </div>

  <!-- Stats row -->
  <div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
      <div style="background:#fff;border-radius:8px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #84C225;">
        <div style="font-size:.75rem;color:#888;text-transform:uppercase;font-weight:700;">Total Spent</div>
        <div style="font-size:1.5rem;font-weight:800;color:#3d7a00;margin-top:4px;">₹{{ "%.2f"|format(user_stats.total_spent) }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div style="background:#fff;border-radius:8px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #3b82f6;">
        <div style="font-size:.75rem;color:#888;text-transform:uppercase;font-weight:700;">Total Orders</div>
        <div style="font-size:1.5rem;font-weight:800;color:#1d4ed8;margin-top:4px;">{{ user_stats.total_orders }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div style="background:#fff;border-radius:8px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #f59e0b;">
        <div style="font-size:.75rem;color:#888;text-transform:uppercase;font-weight:700;">Avg Order</div>
        <div style="font-size:1.5rem;font-weight:800;color:#d97706;margin-top:4px;">₹{{ "%.2f"|format(user_stats.average_order_value) }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <div style="background:#fff;border-radius:8px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.08);border-left:4px solid #e23744;">
        <div style="font-size:.75rem;color:#888;text-transform:uppercase;font-weight:700;">Favourite</div>
        <div style="font-size:.9rem;font-weight:700;color:#333;margin-top:4px;">{{ user_stats.favorite_product }}</div>
      </div>
    </div>
  </div>

  <!-- Info + top products -->
  <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>{{ user.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ user.email }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Join Date:</strong></td>
                                    <td>{{ user_stats.join_date }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Order:</strong></td>
                                    <td>{{ user_stats.last_order }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Top Purchased Products</h5>
                        </div>
                        <div class="card-body">
                            {% if top_products %}
                                {% for product in top_products %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>{{ product.name }}</strong><br>
                                        <small class="text-muted">{{ product.quantity }} units</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">₹{{ "%.2f"|format(product.total_spent) }}</span>
                                    </div>
                                </div>
                                {% if not loop.last %}<hr>{% endif %}
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No purchase history available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order History -->
            <div class="card" style="border-top:3px solid #84C225;">
                <div class="card-header" style="background:linear-gradient(135deg,#84C225,#3d7a00);color:#fff;display:flex;align-items:center;justify-content:space-between;">
                    <h5 style="margin:0;color:#fff;font-weight:800;"><i class="fas fa-shopping-basket me-2"></i>Purchase History</h5>
                    <span style="background:rgba(255,255,255,.25);padding:3px 12px;border-radius:20px;font-size:.8rem;font-weight:700;">{{ user_orders|length }} orders</span>
                </div>
                <div class="card-body p-0">
                    {% if user_orders %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead style="background:#f7fbf0;">
                                    <tr>
                                        <th style="color:#3d7a00;font-weight:700;padding:12px 16px;">Date</th>
                                        <th style="color:#3d7a00;font-weight:700;">Order ID</th>
                                        <th style="color:#3d7a00;font-weight:700;">Product</th>
                                        <th style="color:#3d7a00;font-weight:700;">Variant</th>
                                        <th style="color:#3d7a00;font-weight:700;">Qty</th>
                                        <th style="color:#3d7a00;font-weight:700;">Price</th>
                                        <th style="color:#3d7a00;font-weight:700;">Total</th>
                                        <th style="color:#3d7a00;font-weight:700;">Payment</th>
                                        <th style="color:#3d7a00;font-weight:700;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in user_orders|sort(attribute='date', reverse=True) %}
                                    <tr>
                                        <td style="padding:10px 16px;font-size:.82rem;color:#555;">
                                            {% if order.date and order.date != 'Never' %}
                                                {{ order.date.strftime('%d %b %Y, %I:%M %p') if order.date is not string else order.date }}
                                            {% else %}—{% endif %}
                                        </td>
                                        <td style="font-size:.78rem;color:#888;">{{ order.order_id or '—' }}</td>
                                        <td style="font-weight:600;color:#333;">{{ order.product_name or 'Unknown' }}</td>
                                        <td style="font-size:.8rem;color:#666;">{{ order.variant_name or '—' }}</td>
                                        <td style="text-align:center;">{{ order.quantity }}</td>
                                        <td>₹{{ "%.2f"|format(order.price|float) }}</td>
                                        <td style="font-weight:700;color:#3d7a00;">₹{{ "%.2f"|format(order.total|float) }}</td>
                                        <td>
                                            <span style="background:#e8f5d0;color:#3d7a00;border-radius:4px;padding:2px 8px;font-size:.72rem;font-weight:700;">
                                                {{ (order.payment_method or 'COD')|upper }}
                                            </span>
                                        </td>
                                        <td>
                                            <span style="background:#d4edda;color:#155724;border-radius:4px;padding:2px 8px;font-size:.72rem;font-weight:700;">
                                                {{ order.status or 'Confirmed' }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot style="background:#f7fbf0;">
                                    <tr>
                                        <td colspan="6" style="text-align:right;font-weight:800;color:#3d7a00;padding:12px 16px;">Grand Total:</td>
                                        <td style="font-weight:800;color:#3d7a00;font-size:1rem;">₹{{ "%.2f"|format(user_stats.total_spent) }}</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div style="text-align:center;padding:40px;color:#888;">
                            <i class="fas fa-shopping-basket" style="font-size:3rem;opacity:.3;margin-bottom:12px;display:block;"></i>
                            No purchase history found for this user.
                        </div>
                    {% endif %}
                </div>
            </div>

</div><!-- /container -->

<script>
async function exportUserPDF(userId) {
    try {
        const response = await fetch(`/admin/export-user-pdf/${userId}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user_report_${userId}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Error generating PDF');
        }
    } catch (error) {
        alert('Error generating PDF: ' + error);
    }
}

async function sendMarketingEmail(userId) {
    try {
        const response = await fetch(`/admin/send-marketing-email/${userId}`);
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error sending email: ' + error);
    }
}
</script>
{% endblock %}