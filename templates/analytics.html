{% extends "base.html" %}
{% block title %}Analytics - Sales Sense AI{% endblock %}

{% block content %}
<div class="page-wrapper analytics-dashboard">

  <!-- Page Header -->
  <div class="analytics-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1 style="margin:0;font-size:1.75rem;">Business Analytics</h1>
        <p class="text-muted mb-0" id="lastUpdated">Loading data…</p>
      </div>
      <div class="d-flex gap-2">
        <select id="dateRange" class="items-select">
          <option value="7">Last 7 Days</option>
          <option value="30" selected>Last 30 Days</option>
          <option value="90">Last 3 Months</option>
          <option value="365">Last Year</option>
        </select>
        <button class="btn btn-outline" onclick="refreshData()" id="refreshBtn">
          <i class="fas fa-rotate-right"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="metrics-grid">
    <div class="stat-card blue">
      <div class="stat-icon"><i class="fas fa-indian-rupee-sign"></i></div>
      <div class="stat-value" id="totalRevenue">₹0</div>
      <div class="stat-label">Total Revenue</div>
      <small class="period-label" style="opacity:.75;font-size:.78rem;">Last 30 Days</small>
    </div>
    <div class="stat-card green">
      <div class="stat-icon"><i class="fas fa-bag-shopping"></i></div>
      <div class="stat-value" id="totalOrders">0</div>
      <div class="stat-label">Total Orders</div>
      <small class="period-label" style="opacity:.75;font-size:.78rem;">Last 30 Days</small>
    </div>
    <div class="stat-card purple">
      <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
      <div class="stat-value" id="avgOrderValue">₹0</div>
      <div class="stat-label">Avg. Order Value</div>
      <small class="period-label" style="opacity:.75;font-size:.78rem;">Last 30 Days</small>
    </div>
    <div class="stat-card orange">
      <div class="stat-icon"><i class="fas fa-users"></i></div>
      <div class="stat-value" id="activeUsers">0</div>
      <div class="stat-label">Active Users</div>
      <small style="opacity:.75;font-size:.78rem;">All Time</small>
    </div>
  </div>

  <!-- Today Quick Stats -->
  <div class="quick-stats-row mb-4">
    <div class="quick-stat-card">
      <div class="qs-label"><i class="fas fa-fire me-1" style="color:var(--orange);"></i>Today's Sales</div>
      <div class="qs-value" id="salesToday">₹0</div>
    </div>
    <div class="quick-stat-card">
      <div class="qs-label"><i class="fas fa-receipt me-1" style="color:var(--info);"></i>Orders Today</div>
      <div class="qs-value" id="ordersToday">0</div>
    </div>
    <div class="quick-stat-card">
      <div class="qs-label"><i class="fas fa-box me-1" style="color:var(--secondary);"></i>Total Products</div>
      <div class="qs-value" id="totalProducts">0</div>
    </div>
    <div class="quick-stat-card">
      <div class="qs-label"><i class="fas fa-warehouse me-1" style="color:var(--purple);"></i>Stock Value (est.)</div>
      <div class="qs-value" id="stockValue">₹0</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-section">
    <div class="chart-card">
      <h5 class="chart-title"><i class="fas fa-chart-area" style="color:var(--primary);"></i> Revenue Trend</h5>
      <div style="position:relative;height:280px;">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h5 class="chart-title"><i class="fas fa-chart-pie" style="color:var(--secondary);"></i> Sales by Category</h5>
      <div style="position:relative;height:280px;">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Products + Insights -->
  <div class="row g-3">
    <div class="col-md-7">
      <div class="card">
        <div class="card-body">
          <h5 class="chart-title mb-3">Top Selling Products</h5>
          <div id="topProductsList">
            <div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading…</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="card">
        <div class="card-body">
          <h5 class="chart-title mb-3"><i class="fas fa-flag" style="color:#84C225;"></i> Product Priority</h5>
          <div id="insightsList">
            <div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading…</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Buyers Report -->
  <div class="row g-3" style="margin-top:4px;">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="chart-title mb-3"><i class="fas fa-crown" style="color:#f59e0b;"></i> Top Buyers Report</h5>
          <div id="topUsersList">
            <div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading…</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
let revenueChart = null;
let categoryChart = null;

function formatINR(val) {
  return '₹' + Number(val || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}
function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
  btn.disabled = true;
  loadAnalytics().finally(() => {
    setTimeout(() => { btn.innerHTML = '<i class="fas fa-rotate-right"></i> Refresh'; btn.disabled = false; }, 600);
  });
}

async function loadAnalytics() {
  const days = document.getElementById('dateRange').value || 30;
  // Update period label on KPI cards
  document.querySelectorAll('.period-label').forEach(el => {
    el.textContent = days == 1 ? 'Today' : `Last ${days} Days`;
  });
  try {
    const res  = await fetch(`/api/business-stats?days=${days}`);
    const data = await res.json();
    setText('totalRevenue',  formatINR(data.total_sales));
    setText('totalOrders',   data.total_orders || 0);
    setText('avgOrderValue', formatINR(data.avg_order_value));
    setText('activeUsers',   data.active_users || 0);
    setText('salesToday',    formatINR(data.sales_today));
    setText('ordersToday',   data.orders_today || 0);
    setText('totalProducts', data.total_products || 0);
    setText('stockValue',    formatINR((data.total_sales || 0) * 0.45));
    setText('lastUpdated',   'Last updated: ' + new Date().toLocaleTimeString('en-IN'));
    buildRevenueChart(data.sales_trend || []);
    buildCategoryChart(data.category_breakdown || []);
    buildTopProducts(data.top_products || []);
    buildInsights(data);
    buildTopUsers(data.top_users || []);
  } catch (e) {
    setText('lastUpdated', 'Error loading — check server connection');
  }
}

function buildRevenueChart(trend) {
  const ctx = document.getElementById('revenueChart').getContext('2d');
  const labels = trend.map(t => t.date || t.period || '');
  const values = trend.map(t => t.sales || t.total || t.revenue || t.amount || 0);
  if (revenueChart) revenueChart.destroy();
  revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels.length ? labels : ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
      datasets: [{ label: 'Revenue (₹)', data: values.length ? values : [0,0,0,0,0,0,0],
        borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.08)', fill: true,
        tension: 0.4, pointBackgroundColor: '#4f46e5', pointBorderColor: '#fff',
        pointBorderWidth: 2, pointRadius: 5, pointHoverRadius: 7 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ' ₹' + Number(ctx.parsed.y).toLocaleString('en-IN', {minimumFractionDigits: 2})
          }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { font: { size: 11 } } },
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.05)' },
             ticks: { callback: v => '₹' + Number(v).toLocaleString('en-IN'), font: { size: 11 } } }
      }
    }
  });
}

function buildCategoryChart(cats) {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const labels = cats.length ? cats.map(c => c.name || c.category || c._id || 'Other')
                              : ['Groceries','Dairy','Snacks','Beverages','Household'];
  const values = cats.length ? cats.map(c => c.total || c.revenue || c.count || 0)
                              : [30, 25, 20, 15, 10];
  const colors = ['#4f46e5','#10b981','#f59e0b','#ef4444','#06b6d4','#8b5cf6','#ec4899','#f97316'];
  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#fff' }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '62%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 }, usePointStyle: true } },
        tooltip: { callbacks: { label: ctx => ` ₹${Number(ctx.parsed).toLocaleString('en-IN')}` } }
      }
    }
  });
}

function buildTopProducts(products) {
  const container = document.getElementById('topProductsList');
  if (!products.length) {
    container.innerHTML = '<p class="text-muted text-center py-3">No product data available</p>'; return;
  }
  const max = Math.max(...products.map(p => p.total_revenue || p.revenue || p.sales || 0)) || 1;
  container.innerHTML = products.slice(0, 8).map((p, i) => {
    const rev = p.total_revenue || p.revenue || p.sales || 0;
    const pct = Math.round((rev / max) * 100);
    return `<div class="d-flex align-items-center gap-3 mb-3">
      <span class="product-rank">${i + 1}</span>
      <div class="flex-grow-1">
        <div class="d-flex justify-content-between mb-1">
          <span class="fw-semibold" style="font-size:.9rem;">${p.name || p._id || 'Product'}</span>
          <span style="font-size:.85rem;color:var(--text-muted);">${formatINR(rev)}</span>
        </div>
        <div class="progress" style="height:6px;">
          <div class="progress-bar" style="width:${pct}%;background:var(--primary);"></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function buildInsights(data) {
  const container = document.getElementById('insightsList');
  const products  = (data.top_products || []).slice(0, 9);
  if (!products.length) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-circle-info me-2"></i>No product data available</p>';
    return;
  }
  const total   = products.length;
  const highEnd = Math.ceil(total / 3);
  const midEnd  = Math.ceil(total * 2 / 3);
  container.innerHTML = products.map((p, i) => {
    const rev   = p.total_revenue || p.revenue || 0;
    const units = p.units_sold   || p.units    || 0;
    let badgeClass, badgeIcon, badgeLabel;
    if (i < highEnd) {
      badgeClass = 'priority-high'; badgeIcon = 'fa-arrow-trend-up';   badgeLabel = 'High';
    } else if (i < midEnd) {
      badgeClass = 'priority-mid';  badgeIcon = 'fa-equals';           badgeLabel = 'Medium';
    } else {
      badgeClass = 'priority-low';  badgeIcon = 'fa-arrow-trend-down'; badgeLabel = 'Low';
    }
    const safeName = (p.name || p._id || 'Product').replace(/'/g, "\\'");
    return `<div class="insight-item" style="cursor:pointer;" onclick="showProductDetail('${safeName}','${badgeLabel}',${units},${rev})">
      <div class="insight-info">
        <div class="insight-name">${p.name || p._id || 'Product'}</div>
        <div class="insight-meta">${units} units &bull; ${formatINR(rev)}</div>
      </div>
      <span class="priority-badge ${badgeClass}"><i class="fas ${badgeIcon}"></i> ${badgeLabel}</span>
    </div>`;
  }).join('');
}

function buildTopUsers(users) {
  const container = document.getElementById('topUsersList');
  if (!container) return;
  if (!users.length) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-circle-info me-2"></i>No buyer data available yet</p>';
    return;
  }
  const max = Math.max(...users.map(u => u.spent)) || 1;
  const medals = ['\uD83E\uDD47','\uD83E\uDD48','\uD83E\uDD49'];
  container.innerHTML = `<div class="table-responsive"><table style="width:100%;border-collapse:collapse;">
    <thead><tr style="background:#f9fafb;font-size:.72rem;text-transform:uppercase;color:#9ca3af;">
      <th style="padding:10px 14px;">#</th>
      <th style="padding:10px 14px;">Buyer Name</th>
      <th style="padding:10px 14px;text-align:center;">Orders</th>
      <th style="padding:10px 14px;text-align:right;">Total Spent</th>
      <th style="padding:10px 14px;">Spend Share</th>
    </tr></thead>
    <tbody>${users.map((u, i) => {
      const pct   = Math.round((u.spent / max) * 100);
      const medal = medals[i] || ('#' + (i + 1));
      const safeUName = (u.name || 'Guest').replace(/'/g, "\\'");
      return `<tr style="border-top:1px solid #f0f0f0;cursor:pointer;" onclick="showUserDetail('${safeUName}')" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background=''">\n        <td style="padding:10px 14px;font-size:1.1rem;">${medal}</td>
        <td style="padding:10px 14px;font-weight:600;">${u.name || 'Guest'} <small style="color:#84C225;font-size:.7rem;"><i class="fas fa-eye"></i></small></td>
        <td style="padding:10px 14px;text-align:center;color:#6b7280;">${u.orders}</td>
        <td style="padding:10px 14px;text-align:right;font-weight:700;color:#16a34a;">${formatINR(u.spent)}</td>
        <td style="padding:10px 14px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="progress" style="flex:1;height:8px;"><div class="progress-bar" style="width:${pct}%;background:#84C225;"></div></div>
            <span style="font-size:.72rem;color:#6b7280;min-width:28px;">${pct}%</span>
          </div>
        </td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
}

/* ─── Product Detail Modal ─── */
async function showProductDetail(name, priority, units, rev) {
  const modal = document.getElementById('detailModal');
  const title = document.getElementById('detailModalTitle');
  const body  = document.getElementById('detailModalBody');
  title.textContent = name;
  body.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x" style="color:#84C225;"></i></div>';
  modal.style.display = 'flex';

  try {
    const res  = await fetch('/api/product-detail?name=' + encodeURIComponent(name));
    const data = await res.json();
    const badgeColor = {High:'#dcfce7',Medium:'#fef9c3',Low:'#fee2e2'}[priority] || '#f3f4f6';
    const badgeText  = {High:'#16a34a',Medium:'#92400e',Low:'#b91c1c'}[priority]  || '#374151';
    body.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:20px;">
        <div style="background:#f0fdf4;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#16a34a;">${formatINR(data.total_revenue||rev)}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Total Revenue</div>
        </div>
        <div style="background:#eff6ff;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#2563eb;">${data.total_units||units}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Units Sold</div>
        </div>
        <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#d97706;">${data.total_orders||0}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Total Orders</div>
        </div>
        <div style="background:#fdf4ff;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#7c3aed;">${data.unique_buyers||0}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Unique Buyers</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
        <span style="background:${badgeColor};color:${badgeText};padding:4px 14px;border-radius:20px;font-size:.8rem;font-weight:700;">Priority: ${priority}</span>
      </div>
      ${(data.records||[]).length ? `
      <div style="max-height:250px;overflow-y:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:.82rem;">
          <thead><tr style="background:#f9fafb;position:sticky;top:0;">
            <th style="padding:8px 10px;text-align:left;">Buyer</th>
            <th style="padding:8px 10px;text-align:center;">Qty</th>
            <th style="padding:8px 10px;text-align:right;">Amount</th>
            <th style="padding:8px 10px;text-align:right;">Date</th>
          </tr></thead>
          <tbody>${(data.records||[]).map(r=>`<tr style="border-top:1px solid #f0f0f0;">
            <td style="padding:7px 10px;">${r.buyer}</td>
            <td style="padding:7px 10px;text-align:center;">${r.quantity}</td>
            <td style="padding:7px 10px;text-align:right;color:#16a34a;font-weight:600;">${formatINR(r.total)}</td>
            <td style="padding:7px 10px;text-align:right;color:#9ca3af;">${r.date}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>` : '<p class="text-muted text-center py-3">No detailed purchase records yet.</p>'}
    `;
  } catch(e) {
    body.innerHTML = '<p class="text-muted text-center py-3">Could not load product details.</p>';
  }
}

/* ─── User Detail Modal ─── */
async function showUserDetail(name) {
  const modal = document.getElementById('detailModal');
  const title = document.getElementById('detailModalTitle');
  const body  = document.getElementById('detailModalBody');
  title.innerHTML = '<i class="fas fa-user me-2" style="color:#84C225;"></i>' + name;
  body.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x" style="color:#84C225;"></i></div>';
  modal.style.display = 'flex';

  try {
    const res  = await fetch('/api/user-detail?name=' + encodeURIComponent(name));
    const data = await res.json();
    body.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-bottom:20px;">
        <div style="background:#f0fdf4;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#16a34a;">${formatINR(data.total_spent)}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Total Spent</div>
        </div>
        <div style="background:#eff6ff;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#2563eb;">${data.total_orders}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Total Orders</div>
        </div>
        <div style="background:#fefce8;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:1.4rem;font-weight:800;color:#d97706;">${data.total_units||0}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Items Bought</div>
        </div>
        <div style="background:#fdf4ff;border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:.95rem;font-weight:700;color:#7c3aed;padding-top:4px;">${(data.categories||[]).slice(0,2).join(', ')||'—'}</div>
          <div style="font-size:.72rem;color:#6b7280;margin-top:2px;">Top Categories</div>
        </div>
      </div>
      ${(data.records||[]).length ? `
      <div style="max-height:260px;overflow-y:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:.82rem;">
          <thead><tr style="background:#f9fafb;position:sticky;top:0;">
            <th style="padding:8px 10px;text-align:left;">Product</th>
            <th style="padding:8px 10px;text-align:left;">Category</th>
            <th style="padding:8px 10px;text-align:center;">Qty</th>
            <th style="padding:8px 10px;text-align:right;">Amount</th>
            <th style="padding:8px 10px;text-align:right;">Date</th>
          </tr></thead>
          <tbody>${(data.records||[]).map(r=>`<tr style="border-top:1px solid #f0f0f0;">
            <td style="padding:7px 10px;font-weight:600;">${r.product}</td>
            <td style="padding:7px 10px;color:#6b7280;">${r.category}</td>
            <td style="padding:7px 10px;text-align:center;">${r.quantity}</td>
            <td style="padding:7px 10px;text-align:right;color:#16a34a;font-weight:600;">${formatINR(r.total)}</td>
            <td style="padding:7px 10px;text-align:right;color:#9ca3af;">${r.date}</td>
          </tr>`).join('')}</tbody>
        </table>
      </div>` : '<p class="text-muted text-center py-3">No purchase records found.</p>'}
    `;
  } catch(e) {
    body.innerHTML = '<p class="text-muted text-center py-3">Could not load user details.</p>';
  }
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetailModal(); });
function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }

document.getElementById('dateRange').addEventListener('change', loadAnalytics);
loadAnalytics();
setInterval(loadAnalytics, 60000);
</script>

<!-- Detail Modal (shared for product + user) -->
<div id="detailModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.45);align-items:center;justify-content:center;padding:16px;" onclick="if(event.target===this)closeDetailModal()">
  <div style="background:#fff;border-radius:14px;width:100%;max-width:680px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.25);">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#84C225,#3d7a00);">
      <h5 id="detailModalTitle" style="margin:0;font-weight:800;color:#fff;font-size:1rem;"></h5>
      <button onclick="closeDetailModal()" style="background:rgba(255,255,255,.25);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;">&times;</button>
    </div>
    <div id="detailModalBody" style="padding:20px;overflow-y:auto;"></div>
  </div>
</div>

{% endblock %}

