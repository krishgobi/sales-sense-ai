{% extends "base.html" %}
{% block title %}Worker Dashboard - Sales Sense AI{% endblock %}

{% block content %}
<div class="page-wrapper" style="padding:1.5rem;">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category == 'error' and 'danger' or category }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Header -->
  <div class="mb-4" style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:1.75rem 2rem;border-radius:16px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1 style="margin:0;font-size:1.75rem;font-weight:700;">üë∑ Welcome, {{ session.worker_name }}!</h1>
        <p style="margin:.25rem 0 0;opacity:.85;">Manage products and track your performance</p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('worker_login') }}" class="btn" style="background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.4);">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="mb-4" style="display:flex;">
    <div class="stat-card blue" style="min-width:220px;">
      <div class="stat-icon"><i class="fas fa-box"></i></div>
      <div class="stat-value">{{ products|length if products else 0 }}</div>
      <div class="stat-label">Total Products</div>
    </div>
  </div>

  <!-- Restock Existing Product -->
  <div class="card mb-4">
    <div class="card-body">
      <h4 class="chart-title mb-3"><i class="fas fa-warehouse" style="color:#10b981;"></i> Restock Existing Product</h4>
      <form id="restockForm">
        <div class="row g-3 mb-3">
          <div class="col-md-5">
            <label class="form-label fw-600 fs-sm">Select Product *</label>
            <select id="restockProduct" class="form-control" required onchange="loadVariants(this.value)">
              <option value="">-- Choose product --</option>
              {% for p in all_products_list %}
              <option value="{{ p._id }}" data-variants="{{ p.variants | tojson | forceescape }}">{{ p.name }} ({{ p.category }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-600 fs-sm">Select Variant *</label>
            <select id="restockVariant" class="form-control" required disabled>
              <option value="">-- Choose variant --</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-600 fs-sm">Add Stock Qty *</label>
            <input type="number" id="restockQty" class="form-control" required min="1" placeholder="e.g. 50">
          </div>
        </div>
        <div id="restockVariantInfo" class="mb-3" style="display:none;">
          <span class="badge" style="background:#d1fae5;color:#065f46;font-size:.85rem;padding:.4rem .9rem;">
            Current stock: <strong id="currentStockVal">0</strong> units
          </span>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Add Stock
          </button>
          <button type="reset" class="btn btn-outline" onclick="resetRestockForm()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
        <div id="restockMessage" class="mt-2"></div>
      </form>
    </div>
  </div>

  <!-- Add New Product Form -->
  <div class="card mb-4">
    <div class="card-body">
      <h4 class="chart-title mb-3"><i class="fas fa-plus-circle" style="color:var(--primary);"></i> Add New Product</h4>
      <form id="addProductForm">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-600 fs-sm">Product Name *</label>
            <input type="text" id="productName" class="form-control" required placeholder="Enter product name">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-600 fs-sm">Category *</label>
            <select id="category" class="form-control" required onchange="handleCategoryChange(this.value)">
              <option value="">-- Select Category --</option>
              {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
              {% endfor %}
              <option value="__new__">+ Add New Category</option>
            </select>
            <input type="text" id="newCategory" class="form-control mt-2" style="display:none;" placeholder="New category name">
          </div>
        </div>

        <!-- Variants -->
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="fw-bold" style="font-size:.95rem;">Product Variants</label>
            <button type="button" class="btn btn-outline btn-sm" id="addVariant">
              <i class="fas fa-plus"></i> Add Variant
            </button>
          </div>
          <div id="variants">
            <div class="variant-entry row g-2 mb-2 p-2 rounded" style="background:#f9fafb;border:1.5px dashed #d1d5db;">
              <div class="col-md-4">
                <label style="font-size:.8rem;font-weight:600;">Quantity / Size *</label>
                <input type="text" class="form-control variant-quantity" required placeholder="e.g. 1kg, 500ml">
              </div>
              <div class="col-md-3">
                <label style="font-size:.8rem;font-weight:600;">Price (‚Çπ) *</label>
                <input type="number" step="0.01" class="form-control variant-price" required placeholder="0.00">
              </div>
              <div class="col-md-3">
                <label style="font-size:.8rem;font-weight:600;">Stock *</label>
                <input type="number" class="form-control variant-stock" required placeholder="0">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger w-100 remove-variant" style="display:none;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check"></i> Add Product
          </button>
          <button type="reset" class="btn btn-outline" onclick="clearProductForm()">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
        <div id="formMessage" class="mt-2"></div>
      </form>
    </div>
  </div>

  <!-- Products Table -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h4 class="chart-title mb-0">
          <i class="fas fa-box-open" style="color:var(--primary);"></i> Your Products
          {% if total_pages and total_pages > 1 %}
          <small class="text-muted fw-normal" style="font-size:.8rem;">(Page {{ page }} of {{ total_pages }})</small>
          {% endif %}
        </h4>
        <input type="text" id="productSearch" class="items-select" placeholder="Search products‚Ä¶" oninput="filterProducts(this.value)" style="width:220px;">
      </div>

      <div class="table-responsive">
        <table class="table table-striped" id="productsTable">
          <thead>
            <tr>
              <th>Product Name</th>
              <th>Category</th>
              <th>Variants</th>
              <th>Total Stock</th>
              <th>Status</th>
              <th>Added By</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            {% if product.name %}
            {% set product_stock_ns = namespace(value=0) %}
            {% if product.variants %}
              {% for v in product.variants %}
                {% set product_stock_ns.value = product_stock_ns.value + (v.stock|default(0)|int) %}
              {% endfor %}
            {% endif %}
            <tr id="product-row-{{ product._id }}" data-search="{{ (product.name or '') | lower }} {{ (product.category or '') | lower }}">
              <td><strong>{{ product.name }}</strong></td>
              <td><span class="badge" style="background:rgba(79,70,229,.1);color:var(--primary);padding:.3rem .7rem;">{{ product.category or 'Uncategorized' }}</span></td>
              <td>
                {% if product.variants %}
                  {% for v in product.variants %}
                  <div style="font-size:.8rem;padding:.2rem 0;">
                    <strong>{{ v.quantity|default('‚Äî') }}</strong>
                    ‚Äî ‚Çπ{{ "%.2f"|format(v.price|default(0)|float) }}
                    <span class="badge {% if (v.stock|default(0)|int) < 10 %}bg-danger{% elif (v.stock|default(0)|int) < 50 %}bg-warning{% else %}bg-success{% endif %}">
                      {{ v.stock|default(0) }} units
                    </span>
                  </div>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">No variants</span>
                {% endif %}
              </td>
              <td><strong style="font-size:1.1rem;">{{ product_stock_ns.value }}</strong></td>
              <td>
                {% if product_stock_ns.value < 10 %}
                  <span style="background:#fecaca;color:#991b1b;padding:.3rem .75rem;border-radius:20px;font-size:.8rem;font-weight:600;">üî¥ Low</span>
                {% elif product_stock_ns.value < 50 %}
                  <span style="background:#fed7aa;color:#92400e;padding:.3rem .75rem;border-radius:20px;font-size:.8rem;font-weight:600;">üü° Medium</span>
                {% else %}
                  <span style="background:#d1fae5;color:#065f46;padding:.3rem .75rem;border-radius:20px;font-size:.8rem;font-weight:600;">üü¢ Good</span>
                {% endif %}
              </td>
              <td>{{ product.added_by_name or 'System' }}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct('{{ product._id }}', '{{ (product.name or 'Product') | replace("'", "\\'") }}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endif %}
            {% else %}
            <tr>
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="fas fa-inbox" style="font-size:3rem;opacity:.3;display:block;margin-bottom:.75rem;"></i>
                No products yet. Use the form above to add your first product.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if total_pages and total_pages > 1 %}
      <div class="pagination mt-3">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}" class="page-btn">‚Üê Prev</a>
        {% endif %}
        {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
          <span class="page-btn active">{{ p }}</span>
          {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
          <a href="?page={{ p }}" class="page-btn">{{ p }}</a>
          {% elif p == page - 3 or p == page + 3 %}
          <span class="page-btn">‚Ä¶</span>
          {% endif %}
        {% endfor %}
        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}" class="page-btn">Next ‚Üí</a>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

</div><!-- /.page-wrapper -->
{% endblock %}

{% block scripts %}
<script>
/* ‚îÄ‚îÄ Variant management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const variantsContainer = document.getElementById('variants');

document.getElementById('addVariant').addEventListener('click', function() {
  const html = `
    <div class="variant-entry row g-2 mb-2 p-2 rounded" style="background:#f9fafb;border:1.5px dashed #d1d5db;">
      <div class="col-md-4">
        <label style="font-size:.8rem;font-weight:600;">Quantity / Size *</label>
        <input type="text" class="form-control variant-quantity" required placeholder="e.g. 1kg, 500ml">
      </div>
      <div class="col-md-3">
        <label style="font-size:.8rem;font-weight:600;">Price (‚Çπ) *</label>
        <input type="number" step="0.01" class="form-control variant-price" required placeholder="0.00">
      </div>
      <div class="col-md-3">
        <label style="font-size:.8rem;font-weight:600;">Stock *</label>
        <input type="number" class="form-control variant-stock" required placeholder="0">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-outline-danger w-100 remove-variant">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>`;
  variantsContainer.insertAdjacentHTML('beforeend', html);
  updateRemoveButtons();
});

variantsContainer.addEventListener('click', function(e) {
  if (e.target.closest('.remove-variant')) {
    e.target.closest('.variant-entry').remove();
    updateRemoveButtons();
  }
});

function updateRemoveButtons() {
  const entries = variantsContainer.querySelectorAll('.variant-entry');
  entries.forEach((entry, i) => {
    const btn = entry.querySelector('.remove-variant');
    if (btn) btn.style.display = entries.length > 1 ? '' : 'none';
  });
}

/* ‚îÄ‚îÄ Category ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function handleCategoryChange(val) {
  document.getElementById('newCategory').style.display = val === '__new__' ? '' : 'none';
}

/* ‚îÄ‚îÄ Submit product ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('addProductForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const name     = document.getElementById('productName').value.trim();
  const catSel   = document.getElementById('category').value;
  const category = catSel === '__new__' ? document.getElementById('newCategory').value.trim() : catSel;

  const variants = [];
  document.querySelectorAll('.variant-entry').forEach(entry => {
    variants.push({
      quantity: entry.querySelector('.variant-quantity').value.trim(),
      price:    parseFloat(entry.querySelector('.variant-price').value) || 0,
      stock:    parseInt(entry.querySelector('.variant-stock').value) || 0
    });
  });

  if (!name || !category || !variants.length) {
    showMsg('Please fill all required fields.', 'danger'); return;
  }

  const btn = this.querySelector('button[type=submit]');
  btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding‚Ä¶';

  fetch('/worker/add-product', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ name, category, variants })
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      showMsg('‚úÖ Product added successfully!', 'success');
      this.reset(); clearProductForm();
      setTimeout(() => location.reload(), 1500);
    } else {
      showMsg('‚ùå ' + (d.error || 'Failed to add product'), 'danger');
    }
  })
  .catch(() => showMsg('‚ùå Network error', 'danger'))
  .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check"></i> Add Product'; });
});

function showMsg(text, type) {
  const el = document.getElementById('formMessage');
  el.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'danger'}">${text}</div>`;
  setTimeout(() => el.innerHTML = '', 4000);
}

function clearProductForm() {
  const nc = document.getElementById('newCategory');
  if (nc) nc.style.display = 'none';
  const variants = document.getElementById('variants');
  const entries = variants.querySelectorAll('.variant-entry');
  entries.forEach((el, i) => { if (i > 0) el.remove(); });
  variants.querySelectorAll('input').forEach(inp => inp.value = '');
}

/* ‚îÄ‚îÄ Delete product ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function deleteProduct(productId, productName) {
  if (!confirm('Delete "' + productName + '"?\nThis cannot be undone.')) return;
  fetch('/worker/delete-product/' + productId, { method: 'POST' })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      const row = document.getElementById('product-row-' + productId);
      if (row) row.remove();
    } else {
      alert('Failed to delete: ' + (d.error || 'Unknown error'));
    }
  })
  .catch(() => alert('Network error'));
}

/* ‚îÄ‚îÄ Inline search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function filterProducts(q) {
  q = q.toLowerCase();
  document.querySelectorAll('#productsTable tbody tr').forEach(row => {
    row.style.display = !row.dataset.search || row.dataset.search.includes(q) ? '' : 'none';
  });
}

/* ‚îÄ‚îÄ Restock: load variants when product selected ‚îÄ */
function loadVariants(productId) {
  const variantSel = document.getElementById('restockVariant');
  const infoBox    = document.getElementById('restockVariantInfo');
  variantSel.innerHTML = '<option value="">-- Choose variant --</option>';
  variantSel.disabled = true;
  infoBox.style.display = 'none';

  if (!productId) return;

  const opt = document.querySelector(`#restockProduct option[value="${productId}"]`);
  if (!opt) return;

  let variants = [];
  try { variants = JSON.parse(opt.dataset.variants || '[]'); } catch(e) {}

  variants.forEach((v, i) => {
    const o = document.createElement('option');
    o.value       = i;
    o.textContent = `${v.quantity || 'Variant ' + (i+1)} ‚Äî ‚Çπ${parseFloat(v.price||0).toFixed(2)} (${v.stock||0} in stock)`;
    o.dataset.stock = v.stock || 0;
    variantSel.appendChild(o);
  });
  variantSel.disabled = false;
}

document.getElementById('restockVariant').addEventListener('change', function() {
  const opt     = this.options[this.selectedIndex];
  const infoBox = document.getElementById('restockVariantInfo');
  if (opt && opt.value !== '') {
    document.getElementById('currentStockVal').textContent = opt.dataset.stock || 0;
    infoBox.style.display = '';
  } else {
    infoBox.style.display = 'none';
  }
});

/* ‚îÄ‚îÄ Restock: submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('restockForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const productId    = document.getElementById('restockProduct').value;
  const variantIndex = document.getElementById('restockVariant').value;
  const qty          = parseInt(document.getElementById('restockQty').value) || 0;

  if (!productId || variantIndex === '' || qty < 1) {
    showRestockMsg('Please fill all fields correctly.', 'danger'); return;
  }

  const btn = this.querySelector('button[type=submit]');
  btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating‚Ä¶';

  fetch('/worker/restock', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ product_id: productId, variant_index: parseInt(variantIndex), add_qty: qty })
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      showRestockMsg(`‚úÖ Stock updated! New stock: ${d.new_stock} units`, 'success');
      // update the current stock badge
      const opt = document.querySelector(`#restockVariant option[value="${variantIndex}"]`);
      if (opt) {
        opt.dataset.stock = d.new_stock;
        opt.textContent   = opt.textContent.replace(/\(\d+ in stock\)/, `(${d.new_stock} in stock)`);
        document.getElementById('currentStockVal').textContent = d.new_stock;
      }
      document.getElementById('restockQty').value = '';
      setTimeout(() => location.reload(), 1800);
    } else {
      showRestockMsg('‚ùå ' + (d.error || 'Failed to update stock'), 'danger');
    }
  })
  .catch(() => showRestockMsg('‚ùå Network error', 'danger'))
  .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Stock'; });
});

function showRestockMsg(text, type) {
  const el = document.getElementById('restockMessage');
  el.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'danger'}">${text}</div>`;
  setTimeout(() => el.innerHTML = '', 5000);
}

function resetRestockForm() {
  document.getElementById('restockVariant').innerHTML = '<option value="">-- Choose variant --</option>';
  document.getElementById('restockVariant').disabled = true;
  document.getElementById('restockVariantInfo').style.display = 'none';
}
</script>
{% endblock %}
  
