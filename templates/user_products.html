{% extends "base.html" %}

{% block content %}
<!-- BB-style page header bar -->
<div style="background:#fff;border-bottom:2px solid #84C225;padding:14px 0;margin-bottom:20px;">
  <div class="container d-flex align-items-center justify-content-between">
    <div>
      <span style="font-weight:800;font-size:1.15rem;color:#3d7a00;"><i class="fas fa-shopping-basket me-2"></i>Welcome, {{ user.name }}!</span>
      <span style="font-size:.8rem;color:#888;margin-left:10px;">Browse &amp; add products to your basket</span>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('view_cart') }}" style="background:#fff;border:2px solid #84C225;color:#3d7a00;font-weight:700;padding:8px 18px;border-radius:6px;text-decoration:none;font-size:.85rem;display:flex;align-items:center;gap:6px;">
        <i class="fas fa-shopping-basket"></i> My Basket
        <span style="background:#84C225;color:#fff;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:800;" id="cart-count">{{ cart|length }}</span>
      </a>
      <a href="{{ url_for('labor_logout') }}" style="background:#fff;border:2px solid #e23744;color:#e23744;font-weight:700;padding:8px 18px;border-radius:6px;text-decoration:none;font-size:.85rem;">Logout</a>
    </div>
  </div>
</div>
<div class="container">
  <div class="row mb-3" style="display:none"></div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search products...">
                <select id="categoryFilter" class="form-select" style="max-width: 200px;">
                    <option value="">All Categories</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row" id="productsGrid">
        {% for product in products %}
        <div class="col-md-4 mb-4 product-card" 
             data-category="{{ product.category }}"
             data-name="{{ product.name }}">
                            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <h5 class="card-title mb-0" style="font-size:.95rem;font-weight:800;color:#333;">{{ product.name }}</h5>
                      {% if product.festival_discount %}
                      <span style="background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;font-size:.68rem;font-weight:700;padding:3px 8px;border-radius:4px;">
                          {{ product.festival_discount.emoji }} {{ product.festival_discount.label }}
                      </span>
                      {% endif %}
                    </div>
                    <p class="card-text" style="font-size:.78rem;color:#888;margin-bottom:8px;"><i class="fas fa-tag me-1" style="color:#84C225;"></i>{{ product.category }}</p>
                    <div id="variants-container-{{ product._id }}">
                        {% for variant in product.variants %}
                        <div class="variant-row mb-3 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="variant-info">
                                    {{ variant.quantity }} &mdash;
                                    {% if variant.original_price is defined %}
                                        <s class="text-muted">&#8377;{{ "%.2f"|format(variant.original_price) }}</s>
                                        <strong class="text-success ms-1">&#8377;{{ "%.2f"|format(variant.price) }}</strong>
                                    {% else %}
                                        &#8377;{{ variant.price }}
                                    {% endif %}
                                    <small class="text-muted">({{ variant.stock }} in stock)</small>
                                </span>
                                <div class="form-check">
                                    <input class="form-check-input variant-checkbox" 
                                           type="checkbox" 
                                           value="{{ loop.index0 }}"
                                           id="variant-check-{{ product._id }}-{{ loop.index0 }}"
                                           data-product-id="{{ product._id }}"
                                           data-variant-index="{{ loop.index0 }}"
                                           data-price="{{ variant.price }}"
                                           data-quantity-type="{{ variant.quantity }}"
                                           data-stock="{{ variant.stock }}"
                                           {% if variant.stock <= 0 %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="quantity-input-group" style="display: none;">
                                <div class="input-group">
                                    <span class="input-group-text">Qty:</span>
                                    <input type="number" 
                                           class="form-control variant-quantity" 
                                           min="1"
                                           max="{{ variant.stock }}"
                                           value="1"
                                           data-variant-index="{{ loop.index0 }}"
                                           {% if variant.stock <= 0 %}disabled{% endif %}>
                                    <span class="input-group-text">Total: &#8377;<span class="variant-total">{{ variant.price }}</span></span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Total Selected: <span class="product-total-price">₹0.00</span></span>
                        <button class="btn btn-success add-to-cart-btn" 
                                style="background:#84C225;border-color:#84C225;font-weight:700;font-size:.82rem;"
                                data-product-id="{{ product._id }}"
                                data-product-name="{{ product.name }}">
                            <i class="fas fa-plus me-1"></i>Add to Basket
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize category filter
    const categories = new Set();
    document.querySelectorAll('.product-card').forEach(card => {
        categories.add(card.dataset.category);
    });

    const categoryFilter = document.getElementById('categoryFilter');
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });

    // Filter function
    function filterProducts() {
        const selectedCategory = categoryFilter.value.toLowerCase();
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        document.querySelectorAll('.product-card').forEach(card => {
            const category = card.dataset.category.toLowerCase();
            const name = card.dataset.name.toLowerCase();
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesSearch = !searchTerm || name.includes(searchTerm);
            
            card.style.display = matchesCategory && matchesSearch ? '' : 'none';
        });
    }

    // Add event listeners
    categoryFilter.addEventListener('change', filterProducts);
    document.getElementById('searchInput').addEventListener('input', filterProducts);

    // Handle variant checkbox changes
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const quantityGroup = this.closest('.variant-row').querySelector('.quantity-input-group');
            quantityGroup.style.display = this.checked ? 'block' : 'none';
            updateProductTotal(this.dataset.productId);
        });
    });

    // Handle quantity input changes
    document.querySelectorAll('.variant-quantity').forEach(input => {
        input.addEventListener('input', function() {
            const variantRow = this.closest('.variant-row');
            const checkbox = variantRow.querySelector('.variant-checkbox');
            const price = parseFloat(checkbox.dataset.price);
            const stock = parseInt(checkbox.dataset.stock);
            let quantity = parseInt(this.value) || 0;

            // Validate quantity
            if (quantity < 1) quantity = 1;
            if (quantity > stock) quantity = stock;
            this.value = quantity;

            // Update variant total
            const totalSpan = variantRow.querySelector('.variant-total');
            totalSpan.textContent = (price * quantity).toFixed(2);

            updateProductTotal(checkbox.dataset.productId);
        });
    });

    function updateProductTotal(productId) {
        const container = document.getElementById(`variants-container-${productId}`);
        let total = 0;

        container.querySelectorAll('.variant-checkbox:checked').forEach(checkbox => {
            const variantRow = checkbox.closest('.variant-row');
            const quantity = parseInt(variantRow.querySelector('.variant-quantity').value);
            const price = parseFloat(checkbox.dataset.price);
            total += price * quantity;
        });

        const totalElement = container.closest('.card').querySelector('.product-total-price');
        totalElement.textContent = `₹${total.toFixed(2)}`;
    }

    // Add to Cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            const container = document.getElementById(`variants-container-${productId}`);
            
            const selectedVariants = [];
            let hasStockError = false;

            container.querySelectorAll('.variant-checkbox:checked').forEach(checkbox => {
                const variantRow = checkbox.closest('.variant-row');
                const quantityInput = variantRow.querySelector('.variant-quantity');
                const quantity = parseInt(quantityInput.value) || 0;
                const variantIndex = parseInt(checkbox.getAttribute('value'));
                const quantityType = checkbox.dataset.quantityType;
                const stock = parseInt(checkbox.dataset.stock);

                if (quantity > stock) {
                    alert(`Sorry, only ${stock} items available for ${quantityType}`);
                    hasStockError = true;
                    return;
                }

                if (quantity > 0 && !hasStockError) {
                    selectedVariants.push({
                        variant_index: variantIndex,
                        quantity: quantity
                    });
                }
            });

            if (hasStockError) {
                return;
            }

            if (selectedVariants.length === 0) {
                alert('Please select at least one variant and specify a quantity');
                return;
            }

            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        selected_variants: selectedVariants
                    })
                });

                const result = await response.json();
                if (!result.error) {  // Changed condition to check for absence of error
                    alert(`Added ${productName} variants to cart!`);
                    
                    // Update cart count
                    const cartCount = document.getElementById('cart-count');
                    if (cartCount) {
                        cartCount.textContent = parseInt(cartCount.textContent || 0) + selectedVariants.length;
                    }
                    
                    // Clear selections
                    container.querySelectorAll('.variant-checkbox:checked').forEach(checkbox => {
                        checkbox.checked = false;
                        const quantityGroup = checkbox.closest('.variant-row').querySelector('.quantity-input-group');
                        if (quantityGroup) {
                            quantityGroup.style.display = 'none';
                        }
                    });
                    updateProductTotal(productId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error adding to cart: ' + error.message);
            }

            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        variant_index: variantIndex,
                        quantity: quantity
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // Update cart count
                    const cartCount = document.getElementById('cart-count');
                    cartCount.textContent = parseInt(cartCount.textContent || 0) + 1;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error adding to cart: ' + error);
            }
        });
    });
});</script>
{% endblock %}