{% extends "base.html" %}
{% block title %}Products - Sales Sense AI{% endblock %}

{% block head %}
<style>
.cat-tab-pill {
  background: #f3f4f6;
  border: 1.5px solid #e5e7eb;
  border-radius: 20px;
  padding: 6px 16px;
  font-size: .82rem;
  font-weight: 600;
  cursor: pointer;
  color: #374151;
  transition: all .18s;
}
.cat-tab-pill:hover {
  background: #e8f5d0;
  border-color: #84C225;
  color: #3a5a00;
}
.cat-tab-pill.active {
  background: #84C225;
  border-color: #84C225;
  color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">

  <!-- Header -->
  <div class="products-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h1 style="margin:0;font-size:1.75rem;">Products Catalog</h1>
      <a href="{{ url_for('guest_view_cart') }}" class="btn btn-light">
        <i class="fas fa-cart-shopping"></i> View Cart
        <span class="badge bg-danger ms-1" id="cart-count">{{ cart|length if cart else 0 }}</span>
      </a>
    </div>
    <div class="header-controls mt-3">
      <input type="text" id="searchInput" placeholder="🔍 Search products…" class="search-input">
      <select id="categoryFilter" class="items-select">
        <option value="">All Categories</option>
        {% set categories = [] %}
        {% for product in products %}
          {% if product.category and product.category not in categories %}
            {% set _ = categories.append(product.category) %}
            <option value="{{ product.category }}">{{ product.category }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <select id="itemsPerPage" class="items-select">
        <option value="12">Show 12</option>
        <option value="24">Show 24</option>
        <option value="48">Show 48</option>
        <option value="all">Show All</option>
      </select>
    </div>
  </div>

  <!-- Category Tab Pills -->
  <div id="catPills" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
    <button class="cat-tab-pill active" data-cat="" onclick="setCatPill(this,'')">
      <i class="fas fa-th"></i> All
    </button>
    {% set cats2 = [] %}
    {% for product in products %}
      {% if product.category and product.category not in cats2 %}
        {% set _ = cats2.append(product.category) %}
        <button class="cat-tab-pill" data-cat="{{ product.category }}" onclick="setCatPill(this,'{{ product.category }}')">
          {{ product.category }}
        </button>
      {% endif %}
    {% endfor %}
  </div>

  <!-- Products Grid -->
  <div id="productsGrid">
    {% for product in products %}
    <div class="product-card-wrapper"
         data-name="{{ (product.name or '') | lower }}"
         data-category="{{ product.category or '' }}">
      <div class="card h-100">
        <div class="product-img-area" style="background:{{ product.image_color or '#f9f9f9' }};">
          <span class="product-emoji">{{ product.emoji or '📦' }}</span>
          {% if product.festival_discount %}
          <span class="festival-badge-img">{{ product.festival_discount.emoji }} {{ product.festival_discount.label }}</span>
          {% endif %}
          {% if product.variants %}
            {% set v = product.variants[0] %}
            {% if v.original_price is defined and v.original_price > v.price %}
            <span class="discount-badge">{{ ((1 - v.price / v.original_price) * 100)|int }}% OFF</span>
            {% endif %}
          {% elif product.original_price is defined and product.original_price > product.price %}
          <span class="discount-badge">{{ ((1 - product.price / product.original_price) * 100)|int }}% OFF</span>
          {% endif %}
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ product.name or 'Unknown Product' }}</h5>
          <span class="product-category mb-2">{{ product.category or 'Uncategorized' }}</span>

          {% if product.description %}
          <p class="card-text text-muted" style="font-size:.85rem;">{{ product.description }}</p>
          {% endif %}

          {% if product.unit %}
          <p class="card-text"><small><strong>Unit:</strong> {{ product.unit }}</small></p>
          {% endif %}

          <div class="mt-auto">
            {% if product.variants and product.variants|length > 0 %}
              {% for variant in product.variants %}
              <div class="variant-item mb-2">
                <div class="d-flex justify-content-between align-items-center">
                  <strong style="font-size:.9rem;">{{ variant.name or 'Regular' }}</strong>
                  <span class="badge {% if variant.stock > 50 %}bg-success{% elif variant.stock > 20 %}bg-warning{% else %}bg-danger{% endif %}">
                    {{ variant.stock or 0 }} units
                  </span>
                </div>
                {% if variant.original_price is defined %}
                <div class="product-price">
                  <span style="text-decoration:line-through;color:#aaa;font-size:.85rem;">&#8377;{{ "%.2f"|format(variant.original_price) }}</span>
                  <span style="color:#16a34a;font-weight:700;margin-left:.4rem;">&#8377;{{ "%.2f"|format(variant.price) }}</span>
                </div>
                {% else %}
                <div class="product-price">&#8377;{{ "%.2f"|format(variant.price or 0) }}</div>
                {% endif %}
                {% if variant.stock and variant.stock > 0 %}
                <div class="input-group mt-2">
                  <input type="number" class="form-control" min="1" max="{{ variant.stock }}"
                         value="1" id="qty-{{ product._id }}-{{ loop.index0 }}"
                         style="border-radius:var(--radius-sm) 0 0 var(--radius-sm)!important;">
                  <button class="btn btn-success"
                          onclick="addToCart('{{ product._id }}', {{ loop.index0 }}, '{{ variant.name or 'Regular' }}', {{ variant.price or 0 }}, '{{ product.name or 'Product' }}')"
                          style="border-radius:0 var(--radius-sm) var(--radius-sm) 0!important;">
                    ADD
                  </button>
                </div>
                {% else %}
                <button class="btn btn-light btn-sm mt-2 w-100" disabled>Out of Stock</button>
                {% endif %}
              </div>
              {% endfor %}
            {% else %}
              {% if product.original_price is defined %}
              <div class="product-price mb-2">
                <span style="text-decoration:line-through;color:#aaa;font-size:.85rem;">&#8377;{{ "%.2f"|format(product.original_price) }}</span>
                <span style="color:#16a34a;font-weight:700;margin-left:.4rem;">&#8377;{{ "%.2f"|format(product.price) }}</span>
              </div>
              {% else %}
              <div class="product-price mb-2">&#8377;{{ "%.2f"|format(product.price or 0) }}</div>
              {% endif %}
              {% if product.stock and product.stock > 0 %}
              <div class="input-group mt-2">
                <input type="number" class="form-control" min="1" max="{{ product.stock }}"
                       value="1" id="qty-{{ product._id }}-0"
                       style="border-radius:var(--radius-sm) 0 0 var(--radius-sm)!important;">
                <button class="btn btn-success"
                        onclick="addToCart('{{ product._id }}', 0, 'Regular', {{ product.price or 0 }}, '{{ product.name or 'Product' }}')"
                        style="border-radius:0 var(--radius-sm) var(--radius-sm) 0!important;">
                  ADD
                </button>
              </div>
              {% else %}
              <button class="btn btn-light btn-sm w-100 mt-2" disabled>Out of Stock</button>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5 text-muted">
      <i class="fas fa-box-open" style="font-size:4rem;opacity:.3;"></i>
      <p class="mt-3 fs-5">No products available</p>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div id="pagination" class="pagination"></div>

</div><!-- /.page-wrapper -->

<!-- Cart Toast -->
<div style="position:fixed;bottom:1rem;right:1rem;z-index:9999;">
  <div id="cartToastEl" class="toast shadow-lg" role="alert" style="min-width:300px;display:none;background:white;border-left:4px solid #84C225;border-radius:8px;padding:1rem 1.25rem;box-shadow:0 4px 20px rgba(0,0,0,.15);">
    <div class="d-flex align-items-center gap-2">
      <i class="fas fa-check-circle text-success fs-5"></i>
      <span id="toastMessage" class="fw-semibold flex-grow-1">Added to cart!</span>
      <button onclick="document.getElementById('cartToastEl').style.display='none'" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:#9ca3af;">&times;</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const allWrappers = Array.from(document.querySelectorAll('.product-card-wrapper'));
let filtered = [...allWrappers];
let currentPage = 1;
let perPage = 12;

document.getElementById('searchInput').addEventListener('input', function() {
  applyFilters();
});
document.getElementById('categoryFilter').addEventListener('change', function() {
  applyFilters();
});
document.getElementById('itemsPerPage').addEventListener('change', function() {
  perPage = this.value === 'all' ? 99999 : parseInt(this.value);
  currentPage = 1;
  renderPage();
});

function applyFilters() {
  const search   = document.getElementById('searchInput').value.toLowerCase().trim();
  const category = document.getElementById('categoryFilter').value;
  filtered = allWrappers.filter(el => {
    const nameMatch = !search || el.dataset.name.includes(search);
    const catMatch  = !category || el.dataset.category === category;
    return nameMatch && catMatch;
  });
  currentPage = 1;
  renderPage();
}

function renderPage() {
  allWrappers.forEach(el => el.style.display = 'none');
  const start = (currentPage - 1) * perPage;
  filtered.slice(start, start + perPage).forEach(el => el.style.display = '');

  const total = Math.ceil(filtered.length / perPage);
  const pg = document.getElementById('pagination');
  pg.innerHTML = '';
  if (total <= 1) return;

  if (currentPage > 1) {
    const b = document.createElement('button');
    b.className = 'page-btn'; b.textContent = '← Prev';
    b.onclick = () => { currentPage--; renderPage(); };
    pg.appendChild(b);
  }
  for (let i = 1; i <= total; i++) {
    const b = document.createElement('button');
    b.className = 'page-btn' + (i === currentPage ? ' active' : '');
    b.textContent = i;
    b.onclick = () => { currentPage = i; renderPage(); };
    pg.appendChild(b);
  }
  if (currentPage < total) {
    const b = document.createElement('button');
    b.className = 'page-btn'; b.textContent = 'Next →';
    b.onclick = () => { currentPage++; renderPage(); };
    pg.appendChild(b);
  }
}

// Read ?cat= or ?search= from URL on load
(function() {
  const params = new URLSearchParams(window.location.search);
  const cat    = params.get('cat') || params.get('category') || '';
  const search = params.get('search') || '';
  if (cat) {
    document.getElementById('categoryFilter').value = cat;
    // Highlight the matching pill
    document.querySelectorAll('.cat-tab-pill').forEach(p => {
      p.classList.toggle('active', p.dataset.cat === cat);
    });
  }
  if (search) {
    document.getElementById('searchInput').value = search;
  }
  if (cat || search) applyFilters();
})();

function setCatPill(btn, cat) {
  document.querySelectorAll('.cat-tab-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('categoryFilter').value = cat;
  applyFilters();
}

renderPage();

function addToCart(productId, variantIndex, variantName, price, productName) {
  const qtyEl = document.getElementById(`qty-${productId}-${variantIndex}`);
  const quantity = parseInt(qtyEl ? qtyEl.value : 1) || 1;
  fetch('/cart/guest-add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product_id: productId, variant_index: variantIndex, variant_name: variantName, price, quantity, product_name: productName })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      document.getElementById('cart-count').textContent = data.cart_items;
      document.getElementById('toastMessage').textContent = `${quantity} × ${productName} (${variantName}) added!`;
      const t = document.getElementById('cartToastEl');
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
      if (qtyEl) qtyEl.value = 1;
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => alert('Cart error: ' + err));
}
</script>
{% endblock %}

