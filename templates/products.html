{% extends "base.html" %}

{% block content %}
<div class="products-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Products Catalog</h2>
        <a href="{{ url_for('guest_view_cart') }}" class="btn btn-primary">
            <i class="bi bi-cart"></i> View Cart 
            <span class="badge bg-light text-dark" id="cart-count">{{ cart|length if cart else 0 }}</span>
        </a>
    </div>
    
    <div class="filters mb-4">
        <div class="row">
            <div class="col-md-4">
                <select id="categoryFilter" class="form-select">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Search products...">
            </div>
        </div>
    </div>

    <div class="row" id="productsGrid">
        {% for product in products %}
        <div class="col-md-3 mb-4 product-card" 
             data-category="{{ product.category }}"
             data-name="{{ product.name }}">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text"><strong>Category:</strong> {{ product.category }}</p>
                    {% if product.description %}
                    <p class="card-text text-muted" style="font-size: 0.9em;">{{ product.description }}</p>
                    {% endif %}
                    {% if product.unit %}
                    <p class="card-text"><strong>Unit:</strong> {{ product.unit }}</p>
                    {% endif %}
                    
                    {% if product.variants and product.variants|length > 0 %}
                        <div class="variants-section mt-3">
                            <p class="card-text"><strong>Variants:</strong></p>
                            <div class="variants-list" style="font-size: 0.9em;">
                                {% for variant in product.variants %}
                                <div class="variant-item p-2 mb-2 border rounded" style="background-color: #f8f9fa;">
                                    <div><strong>{{ variant.name if variant.name else 'Regular' }}</strong></div>
                                    <div>Price: <span style="color: #28a745; font-weight: bold;">₹{{ "%.2f"|format(variant.price) }}</span></div>
                                    <div>Stock: <span class="badge {% if variant.stock > 50 %}bg-success{% elif variant.stock > 20 %}bg-warning{% else %}bg-danger{% endif %}">{{ variant.stock }} units</span></div>
                                    {% if variant.sku %}
                                    <div style="font-size: 0.8em; color: #6c757d;">SKU: {{ variant.sku }}</div>
                                    {% endif %}
                                    {% if variant.stock > 0 %}
                                    <div class="input-group mt-2">
                                        <input type="number" class="form-control" min="1" max="{{ variant.stock }}" value="1" id="qty-{{ product._id }}-{{ loop.index0 }}">
                                        <button class="btn btn-primary" 
                                                onclick="addToCart('{{ product._id }}', {{ loop.index0 }}, '{{ variant.name if variant.name else 'Regular' }}', {{ variant.price }}, '{{ product.name }}')">
                                            <i class="bi bi-cart-plus"></i> Add to Cart
                                        </button>
                                    </div>
                                    {% else %}
                                    <button class="btn btn-secondary btn-sm mt-2 w-100" disabled>Out of Stock</button>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="mt-3">
                            <p class="card-text"><strong>Price:</strong> <span style="color: #28a745; font-weight: bold; font-size: 1.2em;">₹{{ "%.2f"|format(product.price if product.price else 0) }}</span></p>
                            <p class="card-text"><strong>Stock:</strong> 
                                {% if product.stock is defined %}
                                <span class="badge {% if product.stock > 50 %}bg-success{% elif product.stock > 20 %}bg-warning{% else %}bg-danger{% endif %}">{{ product.stock }} units</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </p>
                            {% if product.stock and product.stock > 0 %}
                            <div class="input-group mt-2">
                                <input type="number" class="form-control" min="1" max="{{ product.stock }}" value="1" id="qty-{{ product._id }}-0">
                                <button class="btn btn-primary" 
                                        onclick="addToCart('{{ product._id }}', 0, 'Regular', {{ product.price if product.price else 0 }}, '{{ product.name }}')">
                                    <i class="bi bi-cart-plus"></i> Add to Cart
                                </button>
                            </div>
                            {% else %}
                            <button class="btn btn-secondary w-100 mt-2" disabled>Out of Stock</button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Cart Success Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="cartToast" class="toast" role="alert">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Item added to cart!
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Complete Your Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
        </div>
    </div>
</div>

<script>
function addToCart(productId, variantIndex, variantName, price, productName) {
    const qtyInput = document.getElementById(`qty-${productId}-${variantIndex}`);
    const quantity = parseInt(qtyInput.value) || 1;
    
    // Send to server
    fetch('/cart/guest-add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            product_id: productId,
            variant_index: variantIndex,
            variant_name: variantName,
            price: price,
            quantity: quantity,
            product_name: productName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count
            const cartCount = document.getElementById('cart-count');
            cartCount.textContent = data.cart_items;
            
            // Show toast notification
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = `Added ${quantity} x ${productName} (${variantName}) to cart!`;
            const toast = new bootstrap.Toast(document.getElementById('cartToast'));
            toast.show();
            
            // Reset quantity
            qtyInput.value = 1;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error adding to cart: ' + error);
    });
}
</script>
{% endblock %}
