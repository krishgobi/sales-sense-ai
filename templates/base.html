<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Auto-refresh every 15 minutes (900 seconds) -->
    <meta http-equiv="refresh" content="900">
    <title>SalesSense - Supermarket Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">SalesSense</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/worker">Worker</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/labor">Labor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">Products</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Auto-refresh functionality -->
    <script>
        // Auto-refresh configuration
        const AUTO_REFRESH_INTERVAL = 15 * 60 * 1000; // 15 minutes in milliseconds
        const WARNING_TIME = 2 * 60 * 1000; // Show warning 2 minutes before refresh
        
        let refreshTimer;
        let warningTimer;
        let countdownTimer;
        let refreshToast;
        
        // Initialize auto-refresh system
        function initAutoRefresh() {
            // Set main refresh timer
            refreshTimer = setTimeout(() => {
                refreshPage();
            }, AUTO_REFRESH_INTERVAL);
            
            // Set warning timer
            warningTimer = setTimeout(() => {
                showRefreshWarning();
            }, AUTO_REFRESH_INTERVAL - WARNING_TIME);
            
            console.log('Auto-refresh enabled: Page will refresh in 15 minutes');
        }
        
        // Show refresh warning with countdown
        function showRefreshWarning() {
            // Create toast notification
            const toastHtml = `
                <div class="toast align-items-center text-white bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true" id="refreshToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>ðŸ”„ Auto-refresh in <span id="countdown">120</span> seconds</strong><br>
                            <small>Page will refresh to get latest data</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" onclick="cancelAutoRefresh()"></button>
                    </div>
                </div>
            `;
            
            // Add toast to body
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            // Show toast
            refreshToast = new bootstrap.Toast(document.getElementById('refreshToast'), {
                autohide: false
            });
            refreshToast.show();
            
            // Start countdown
            startCountdown();
        }
        
        // Start countdown display
        function startCountdown() {
            let timeLeft = 120; // 2 minutes
            const countdownElement = document.getElementById('countdown');
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                if (countdownElement) {
                    countdownElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }
        
        // Refresh the page
        function refreshPage() {
            console.log('Auto-refreshing page...');
            // Save scroll position
            sessionStorage.setItem('scrollPosition', window.pageYOffset);
            // Reload page
            window.location.reload();
        }
        
        // Cancel auto-refresh
        function cancelAutoRefresh() {
            clearTimeout(refreshTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            
            if (refreshToast) {
                refreshToast.hide();
            }
            
            console.log('Auto-refresh cancelled by user');
            
            // Show cancellation message
            showMessage('Auto-refresh cancelled. Page will not refresh automatically.', 'info');
        }
        
        // Restore scroll position after refresh
        function restoreScrollPosition() {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo(0, parseInt(scrollPosition));
                sessionStorage.removeItem('scrollPosition');
            }
        }
        
        // Show message to user
        function showMessage(message, type = 'info') {
            const messageHtml = `
                <div class="toast align-items-center text-white bg-${type === 'info' ? 'primary' : type} border-0" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', messageHtml);
            const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
            toast.show();
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const toastElement = document.querySelector('.toast:last-child');
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }
        
        // Reset timers when user interacts with page
        function resetAutoRefresh() {
            // Don't reset if user is typing in an input field
            if (document.activeElement.tagName === 'INPUT' || 
                document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            
            clearTimeout(refreshTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            
            if (refreshToast) {
                refreshToast.hide();
            }
            
            // Restart timers
            initAutoRefresh();
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Restore scroll position if page was refreshed
            restoreScrollPosition();
            
            // Initialize auto-refresh
            initAutoRefresh();
            
            // Reset timer on user activity (but not too frequently)
            let lastActivity = Date.now();
            const ACTIVITY_THRESHOLD = 5 * 60 * 1000; // 5 minutes
            
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, function() {
                    const now = Date.now();
                    if (now - lastActivity > ACTIVITY_THRESHOLD) {
                        resetAutoRefresh();
                        lastActivity = now;
                    }
                });
            });
            
            // Add auto-refresh status indicator
            addRefreshIndicator();
        });
        
        // Add status indicator
        function addRefreshIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'autoRefreshIndicator';
            indicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 123, 255, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1000;
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            indicator.innerHTML = 'ðŸ”„ Auto-refresh: ON';
            indicator.title = 'Click to disable auto-refresh';
            
            indicator.addEventListener('click', function() {
                if (this.innerHTML.includes('ON')) {
                    cancelAutoRefresh();
                    this.innerHTML = 'ðŸ”„ Auto-refresh: OFF';
                    this.style.background = 'rgba(108, 117, 125, 0.8)';
                    this.title = 'Auto-refresh disabled';
                } else {
                    initAutoRefresh();
                    this.innerHTML = 'ðŸ”„ Auto-refresh: ON';
                    this.style.background = 'rgba(0, 123, 255, 0.8)';
                    this.title = 'Click to disable auto-refresh';
                }
            });
            
            document.body.appendChild(indicator);
        }
    </script>
</body>
</html>