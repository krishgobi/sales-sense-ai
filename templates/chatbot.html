<!-- Chatbot Modal -->
<div class="modal fade" id="chatbotModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(135deg,#84C225,#3d7a00);color:#fff;">
                <h5 class="modal-title" style="color:#fff;font-weight:800;"><i class="fas fa-robot me-2"></i>SalesSense AI Assistant</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="chat-container" id="chatContainer" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                    <div class="chat-message bot-message">
                        <strong>AI Assistant:</strong> Hello! I'm your Sales Sense AI assistant. I can help you with sales data, user analytics, inventory status, and more. What would you like to know?
                    </div>
                </div>
                <!-- Quick question chips -->
                <div class="mt-3" style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:10px;">
                    <span style="font-size:.72rem;color:#9ca3af;align-self:center;font-weight:600;text-transform:uppercase;letter-spacing:.04em;">Quick Ask:</span>
                    {% set quick_qs = [
                        ('fa-chart-line','Today\'s sales?'),
                        ('fa-boxes-stacked','Low stock products?'),
                        ('fa-crown','Top selling products?'),
                        ('fa-users','How many users?'),
                        ('fa-indian-rupee-sign','Total revenue this month?'),
                        ('fa-arrow-trend-up','Best performing category?'),
                        ('fa-triangle-exclamation','Any urgent alerts?'),
                        ('fa-calendar','Festival offers this month?')
                    ] %}
                    {% for icon, q in quick_qs %}
                    <button onclick="askQuick('{{ q }}')" style="background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0;border-radius:20px;padding:5px 12px;font-size:.76rem;font-weight:600;cursor:pointer;transition:all .15s;" onmouseover="this.style.background='#84C225';this.style.color='#fff';this.style.borderColor='#84C225'" onmouseout="this.style.background='#f0fdf4';this.style.color='#16a34a';this.style.borderColor='#bbf7d0'">
                        <i class="fas {{ icon }} me-1"></i>{{ q }}
                    </button>
                    {% endfor %}
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Ask me anything about your businessâ€¦" onkeypress="handleChatKeyPress(event)">
                    <button class="btn" style="background:#84C225;color:#fff;font-weight:700;border-color:#84C225;" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot Floating Button -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
    <button style="background:linear-gradient(135deg,#84C225,#3d7a00);color:#fff;border:none;width:56px;height:56px;border-radius:50%;font-size:1.3rem;cursor:pointer;box-shadow:0 4px 16px rgba(132,194,37,.4);transition:all .2s;" data-bs-toggle="modal" data-bs-target="#chatbotModal" title="Open AI Assistant" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <i class="fas fa-robot"></i>
    </button>
</div>

<script>
let chatHistory = [];

function handleChatKeyPress(event) {
    if (event.key === 'Enter') { sendChatMessage(); }
}

function askQuick(question) {
    const input = document.getElementById('chatInput');
    if (input) { input.value = question; sendChatMessage(); }
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addChatMessage('user', message);
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        const response = await fetch('/admin/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const result = await response.json();
        
        // Remove typing indicator
        removeTypingIndicator();
        
        // Add bot response
        addChatMessage('bot', result.response);
        
    } catch (error) {
        removeTypingIndicator();
        addChatMessage('bot', 'Sorry, I encountered an error. Please try again.');
    }
}

function addChatMessage(sender, message) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
        messageDiv.style.backgroundColor = '#007bff';
        messageDiv.style.color = 'white';
        messageDiv.style.marginLeft = 'auto';
        messageDiv.style.textAlign = 'right';
    } else {
        messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${message.replace(/\n/g, '<br>')}`;
        messageDiv.style.backgroundColor = '#e9ecef';
        messageDiv.style.color = '#333';
    }
    
    messageDiv.style.padding = '10px';
    messageDiv.style.marginBottom = '10px';
    messageDiv.style.borderRadius = '10px';
    messageDiv.style.maxWidth = '80%';
    messageDiv.style.wordWrap = 'break-word';
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showTypingIndicator() {
    const chatContainer = document.getElementById('chatContainer');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'chat-message bot-message';
    typingDiv.innerHTML = '<strong>AI Assistant:</strong> <em>Typing...</em>';
    typingDiv.style.backgroundColor = '#e9ecef';
    typingDiv.style.color = '#666';
    typingDiv.style.padding = '10px';
    typingDiv.style.marginBottom = '10px';
    typingDiv.style.borderRadius = '10px';
    typingDiv.style.maxWidth = '80%';
    
    chatContainer.appendChild(typingDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Auto-focus chat input when modal opens
document.getElementById('chatbotModal').addEventListener('shown.bs.modal', function () {
    document.getElementById('chatInput').focus();
});
</script>

<style>
.chat-message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 10px;
    max-width: 70%;
}

.user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

.bot-message {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.chat-container {
    max-height: 400px;
    overflow-y: auto;
}

.btn-floating {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}
</style>