{% extends "base.html" %}

{% block title %}Sales Sense AI - Business Intelligence Platform{% endblock %}

{% block content %}
<div class="home-container">
    <!-- Hero Section -->
    <div class="hero-section text-center mb-5">
        <h1 class="display-4 mb-4">Sales Sense AI</h1>
        <p class="lead">Your Complete Business Intelligence Platform</p>
        <p class="text-muted">Real-time analytics, smart insights, and automated reporting</p>
    </div>

    <!-- Analytics Button -->
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <a href="/analytics" class="btn btn-primary btn-lg shadow">
                <i class="bi bi-graph-up-arrow"></i> Open Advanced Analytics Dashboard
            </a>
        </div>
    </div>

    <!-- Quick Stats Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üìä Real-Time Business Overview</h3>
        </div>
        <div class="col-md-4">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-cash-stack mb-2" style="font-size: 2rem;"></i>
                    <h4 id="totalRevenue">Loading...</h4>
                    <p class="mb-0">Total Revenue</p>
                    <small id="totalOrders">...</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-box-seam mb-2" style="font-size: 2rem;"></i>
                    <h4 id="totalProducts">Loading...</h4>
                    <p class="mb-0">Products</p>
                    <small id="activeUsers">...</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up-arrow mb-2" style="font-size: 2rem;"></i>
                    <h4 id="todaySales">Loading...</h4>
                    <p class="mb-0">Today's Sales</p>
                    <small id="todayOrders">...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reports Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üìà Quick Reports</h3>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Sales Trend (Last 7 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="salesTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Selling Products (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <div id="topProductsList">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Summary Report -->
    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-calendar-week"></i> This Week's Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Weekly Sales</small>
                                <h4 id="weeklySales" class="mb-0">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Weekly Orders</small>
                                <h4 id="weeklyOrders" class="mb-0">0</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Avg Daily Sales</small>
                                <h4 id="avgDailySales" class="mb-0">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Best Selling Day</small>
                                <h4 id="bestDay" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üìà Performance Metrics</h3>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-cart-check text-success" style="font-size: 2.5rem;"></i>
                    <h3 id="avgOrderValue" class="mt-3">$0.00</h3>
                    <p class="text-muted mb-0">Average Order Value</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-people text-primary" style="font-size: 2.5rem;"></i>
                    <h3 id="activeUsersCount" class="mt-3">0</h3>
                    <p class="text-muted mb-0">Active Users (30 Days)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-clock-history text-info" style="font-size: 2.5rem;"></i>
                    <h3 id="lastUpdate" class="mt-3">--:--</h3>
                    <p class="text-muted mb-0">Last Updated</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Panels -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üöÄ System Access</h3>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-shield-check text-primary mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Admin Panel</h3>
                    <p class="card-text">Complete system management, analytics, and business intelligence dashboard</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>üìä Advanced Analytics</li>
                        <li>üë• User Management</li>
                        <li>üìß Email Marketing</li>
                        <li>ü§ñ AI Assistant</li>
                        <li>üìà Real-time Reports</li>
                    </ul>
                    <a href="/admin" class="btn btn-primary btn-lg">Access Admin Panel</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-person-workspace text-success mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Worker Panel</h3>
                    <p class="card-text">Streamlined interface for daily operations and product management</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>üì¶ Product Management</li>
                        <li>üìù Order Processing</li>
                        <li>üìä Performance Tracking</li>
                        <li>üîî Task Notifications</li>
                        <li>üìã Daily Reports</li>
                    </ul>
                    <a href="/worker" class="btn btn-success btn-lg">Access Worker Panel</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-gear-wide-connected text-info mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Labor Management</h3>
                    <p class="card-text">Track workforce activities and optimize labor efficiency</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>‚è∞ Time Tracking</li>
                        <li>üìä Productivity Analytics</li>
                        <li>üë∑ Worker Assignments</li>
                        <li>üìà Performance Metrics</li>
                        <li>üíº Resource Planning</li>
                    </ul>
                    <a href="/labor" class="btn btn-info btn-lg">Access Labor Panel</a>
                </div>
            </div>
        </div>
    </div>



    <!-- Shopping Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üõí Customer Experience</h3>
        </div>
        <div class="col-md-6">
            <div class="card shopping-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-shop text-warning mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Browse Products</h3>
                    <p class="card-text">Explore our comprehensive product catalog with smart recommendations</p>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">AI Recommendations</span>
                        <span class="badge bg-success me-2">Real-time Inventory</span>
                        <span class="badge bg-info">Secure Shopping</span>
                    </div>
                    <a href="/products" class="btn btn-warning btn-lg">Start Shopping</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shopping-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-person-circle text-secondary mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">User Account</h3>
                    <p class="card-text">Manage your profile, orders, and personalized shopping experience</p>
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2">Order History</span>
                        <span class="badge bg-primary me-2">Wishlist</span>
                        <span class="badge bg-success">Rewards</span>
                    </div>
                    <a href="/user/products" class="btn btn-secondary btn-lg">My Account</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">‚ú® Platform Features</h3>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-robot text-primary mb-3" style="font-size: 2.5rem;"></i>
                <h5>AI Assistant</h5>
                <p class="text-muted">Smart chatbot for instant business insights</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-graph-up text-success mb-3" style="font-size: 2.5rem;"></i>
                <h5>Real-time Analytics</h5>
                <p class="text-muted">Live dashboard with auto-refresh every 15 minutes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-envelope-paper text-info mb-3" style="font-size: 2.5rem;"></i>
                <h5>Email Marketing</h5>
                <p class="text-muted">Automated personalized customer outreach</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-file-pdf text-danger mb-3" style="font-size: 2.5rem;"></i>
                <h5>PDF Reports</h5>
                <p class="text-muted">Detailed analytics exported in professional formats</p>
            </div>
        </div>
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 60px 20px;
    border-radius: 15px;
    margin-bottom: 3rem;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3) !important;
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34) !important;
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #117a8b) !important;
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800) !important;
}

.access-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.access-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.shopping-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.shopping-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.feature-card {
    padding: 20px;
    transition: transform 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-3px);
}

.home-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.card {
    border-radius: 10px;
}

.btn-lg {
    padding: 12px 30px;
    font-size: 1.1rem;
    border-radius: 25px;
}

@media (max-width: 768px) {
    .hero-section {
        padding: 40px 15px;
    }
    
    .display-4 {
        font-size: 2rem;
    }
}
</style>

<script>
// Load business statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBusinessStats();
    
    // Refresh stats every 5 minutes
    setInterval(loadBusinessStats, 300000);
});

let salesChart = null;

async function loadBusinessStats() {
    try {
        const response = await fetch('/api/business-stats');
        const data = await response.json();
        
        // Format numbers with commas
        const formatNumber = (num) => num.toLocaleString('en-US');
        const formatCurrency = (num) => '$' + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Update main stats (without total users)
        document.getElementById('totalRevenue').textContent = formatCurrency(data.total_sales || 0);
        document.getElementById('totalOrders').textContent = `${formatNumber(data.total_orders || 0)} orders`;
        document.getElementById('totalProducts').textContent = formatNumber(data.total_products || 0);
        document.getElementById('activeUsers').textContent = `${formatNumber(data.active_users || 0)} active`;
        document.getElementById('todaySales').textContent = formatCurrency(data.sales_today || 0);
        document.getElementById('todayOrders').textContent = `${data.orders_today || 0} orders today`;
        
        // Update performance metrics
        document.getElementById('avgOrderValue').textContent = formatCurrency(data.avg_order_value || 0);
        document.getElementById('activeUsersCount').textContent = formatNumber(data.active_users || 0);
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        
        // Update sales trend chart
        if (data.sales_trend && data.sales_trend.length > 0) {
            updateSalesTrendChart(data.sales_trend);
            updateWeeklySummary(data.sales_trend);
        }
        
        // Update top products list
        if (data.top_products && data.top_products.length > 0) {
            updateTopProducts(data.top_products);
        }
        
    } catch (error) {
        console.error('Error loading business stats:', error);
        document.getElementById('totalRevenue').textContent = '--';
        document.getElementById('totalProducts').textContent = '--';
        document.getElementById('todaySales').textContent = '--';
    }
}

function updateSalesTrendChart(trendData) {
    const ctx = document.getElementById('salesTrendChart');
    if (!ctx) return;
    
    const labels = trendData.map(d => d.date);
    const values = trendData.map(d => d.sales);
    
    if (salesChart) {
        salesChart.destroy();
    }
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales ($)',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('en-US');
                        }
                    }
                }
            }
        }
    });
}

function updateTopProducts(products) {
    const container = document.getElementById('topProductsList');
    if (!container) return;
    
    if (products.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No sales data available</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    products.forEach((product, index) => {
        const badgeClass = index === 0 ? 'warning' : index === 1 ? 'secondary' : 'info';
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-${badgeClass} me-2">#${index + 1}</span>
                    <strong>${product.name}</strong>
                    <small class="text-muted d-block">${product.units} units sold</small>
                </div>
                <span class="badge bg-success rounded-pill">$${product.revenue.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateWeeklySummary(trendData) {
    // Calculate weekly stats (last 7 days)
    const weeklySales = trendData.reduce((sum, day) => sum + day.sales, 0);
    const weeklyOrders = trendData.length; // Approximate
    const avgDaily = weeklySales / 7;
    
    // Find best day
    let bestDay = trendData.reduce((max, day) => day.sales > max.sales ? day : max, trendData[0]);
    
    document.getElementById('weeklySales').textContent = '$' + weeklySales.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('weeklyOrders').textContent = (weeklyOrders * 10).toLocaleString(); // Approximate multiplier
    document.getElementById('avgDailySales').textContent = '$' + avgDaily.toLocaleString('en-US', {minimumFractionDigits: 2});
    document.getElementById('bestDay').textContent = bestDay ? bestDay.date : '--';
}
</script>

    <!-- Additional Features Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üöÄ Quick Actions</h3>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="card-title">Products</h3>
                    <p class="card-text">View and manage products</p>
                    <a href="/products" class="btn btn-primary">View Products</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}