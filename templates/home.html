{% extends "base.html" %}

{% block title %}Sales Sense AI - Business Intelligence Platform{% endblock %}

{% block content %}
<div class="home-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <h1 style="color: #fbbf24; font-weight: 700;">üìä Sales Sense AI</h1>
        <p class="lead" style="color: #fbbf24; font-weight: 600;">Your Complete Business Intelligence Platform</p>
        <p style="color: #b45309; font-size: 1rem; font-weight: 600;">Real-time analytics, smart insights, and automated reporting</p>
        <div class="mt-4">
            <a href="/analytics" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-graph-up-arrow"></i> Advanced Analytics
            </a>
            <button onclick="exportBusinessSummaryPDF()" class="btn btn-danger btn-lg">
                <i class="bi bi-file-pdf"></i> Export PDF
            </button>
        </div>
    </div>

    <!-- Quick Stats Section -->
    <div class="row mb-4">
        <div class="col-md-12 mb-3">
            <h3 class="text-center" style="color: white; font-weight: 700;">ÔøΩ Real-Time Business Overview</h3>
        </div>
        <div class="col-md-4">
            <div class="stat-card success">
                <div class="text-center">
                    <i class="bi bi-cash-stack stat-icon" style="color: #10B981;"></i>
                    <div class="stat-value" id="totalRevenue">Loading...</div>
                    <div class="stat-label">Total Revenue</div>
                    <small class="text-muted" id="totalOrders">...</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card warning">
                <div class="text-center">
                    <i class="bi bi-box-seam stat-icon" style="color: #F59E0B;"></i>
                    <div class="stat-value" id="totalProducts">Loading...</div>
                    <div class="stat-label">Products</div>
                    <small class="text-muted" id="activeUsers">...</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="text-center">
                    <i class="bi bi-graph-up-arrow stat-icon" style="color: #4F46E5;"></i>
                    <div class="stat-value" id="todaySales">Loading...</div>
                    <div class="stat-label">Today's Sales</div>
                    <small class="text-muted" id="todayOrders">...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reports Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Sales Trend (Last 7 Days)
                </div>
                <div class="card-body">
                    <canvas id="salesTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-trophy"></i> Top Selling Products (Last 30 Days)
                </div>
                <div class="card-body">
                    <div id="topProductsList">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Weekly Sales</small>
                                <h4 id="weeklySales" class="mb-0">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Weekly Orders</small>
                                <h4 id="weeklyOrders" class="mb-0">0</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Avg Daily Sales</small>
                                <h4 id="avgDailySales" class="mb-0">$0.00</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted">Best Selling Day</small>
                                <h4 id="bestDay" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üìà Performance Metrics</h3>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-cart-check text-success" style="font-size: 2.5rem;"></i>
                    <h3 id="avgOrderValue" class="mt-3">$0.00</h3>
                    <p class="text-muted mb-0">Average Order Value</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-people text-primary" style="font-size: 2.5rem;"></i>
                    <h3 id="activeUsersCount" class="mt-3">0</h3>
                    <p class="text-muted mb-0">Active Users (30 Days)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="bi bi-clock-history text-info" style="font-size: 2.5rem;"></i>
                    <h3 id="lastUpdate" class="mt-3">--:--</h3>
                    <p class="text-muted mb-0">Last Updated</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Intelligent Business Intelligence Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Smart Business Intelligence
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="loadNotifications()" id="refreshNotificationsBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Notifications Summary -->
                        <div class="col-md-4">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-bell"></i> Smart Alerts</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-danger"><i class="bi bi-exclamation-triangle"></i> High Priority</span>
                                        <span class="badge bg-danger" id="highPriorityCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-warning"><i class="bi bi-info-circle"></i> Medium Priority</span>
                                        <span class="badge bg-warning" id="mediumPriorityCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-info"><i class="bi bi-check-circle"></i> Low Priority</span>
                                        <span class="badge bg-info" id="lowPriorityCount">0</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100" onclick="showAllNotifications()">
                                        <i class="bi bi-list"></i> View All Alerts
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Product Performance Insights -->
                        <div class="col-md-4">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-graph-up"></i> Product Insights</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Top Performers</small>
                                        <div class="badge bg-success" id="topPerformersCount">Loading...</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Low Performers</small>
                                        <div class="badge bg-danger" id="lowPerformersCount">Loading...</div>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted">Analysis Period</small>
                                        <div class="text-primary fw-bold">Last 3 Months</div>
                                    </div>
                                    <button class="btn btn-success btn-sm w-100" onclick="showProductInsights()">
                                        <i class="bi bi-bar-chart"></i> Detailed Analysis
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Festival Calendar -->
                        <div class="col-md-4">
                            <div class="card h-100 border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-calendar-event"></i> Festival Calendar</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <small class="text-muted">Upcoming Festivals</small>
                                        <div class="badge bg-info" id="upcomingFestivalsCount">Loading...</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Recommended Promotions</small>
                                        <div class="badge bg-primary" id="recommendedPromotionsCount">Loading...</div>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted">Current Month</small>
                                        <div class="text-info fw-bold" id="currentMonthName">December</div>
                                    </div>
                                    <button class="btn btn-info btn-sm w-100" onclick="showFestivalCalendar()">
                                        <i class="bi bi-calendar3"></i> View Calendar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="loadNotifications()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Intelligence
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="exportInsights()">
                                    <i class="bi bi-download"></i> Export Insights
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="window.location.href='/analytics'">
                                    <i class="bi bi-graph-up-arrow"></i> Full Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Access Panels -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üöÄ System Access</h3>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-shield-check text-primary mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Admin Panel</h3>
                    <p class="card-text">Complete system management, analytics, and business intelligence dashboard</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>üìä Advanced Analytics</li>
                        <li>üë• User Management</li>
                        <li>üìß Email Marketing</li>
                        <li>ü§ñ AI Assistant</li>
                        <li>üìà Real-time Reports</li>
                    </ul>
                    <a href="/admin" class="btn btn-primary btn-lg">Access Admin Panel</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-person-workspace text-success mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Worker Panel</h3>
                    <p class="card-text">Streamlined interface for daily operations and product management</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>üì¶ Product Management</li>
                        <li>üìù Order Processing</li>
                        <li>üìä Performance Tracking</li>
                        <li>üîî Task Notifications</li>
                        <li>üìã Daily Reports</li>
                    </ul>
                    <a href="/worker" class="btn btn-success btn-lg">Access Worker Panel</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card access-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-gear-wide-connected text-info mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Labor Management</h3>
                    <p class="card-text">Track workforce activities and optimize labor efficiency</p>
                    <ul class="list-unstyled text-start mb-4">
                        <li>‚è∞ Time Tracking</li>
                        <li>üìä Productivity Analytics</li>
                        <li>üë∑ Worker Assignments</li>
                        <li>üìà Performance Metrics</li>
                        <li>üíº Resource Planning</li>
                    </ul>
                    <a href="/labor" class="btn btn-info btn-lg">Access Labor Panel</a>
                </div>
            </div>
        </div>
    </div>



    <!-- Shopping Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üõí Customer Experience</h3>
        </div>
        <div class="col-md-6">
            <div class="card shopping-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-shop text-warning mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">Browse Products</h3>
                    <p class="card-text">Explore our comprehensive product catalog with smart recommendations</p>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">AI Recommendations</span>
                        <span class="badge bg-success me-2">Real-time Inventory</span>
                        <span class="badge bg-info">Secure Shopping</span>
                    </div>
                    <a href="/products" class="btn btn-warning btn-lg">Start Shopping</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shopping-card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-person-circle text-secondary mb-3" style="font-size: 3rem;"></i>
                    <h3 class="card-title">User Account</h3>
                    <p class="card-text">Manage your profile, orders, and personalized shopping experience</p>
                    <div class="mb-3">
                        <span class="badge bg-secondary me-2">Order History</span>
                        <span class="badge bg-primary me-2">Wishlist</span>
                        <span class="badge bg-success">Rewards</span>
                    </div>
                    <a href="/user/products" class="btn btn-secondary btn-lg">My Account</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">‚ú® Platform Features</h3>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-robot text-primary mb-3" style="font-size: 2.5rem;"></i>
                <h5>AI Assistant</h5>
                <p class="text-muted">Smart chatbot for instant business insights</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-graph-up text-success mb-3" style="font-size: 2.5rem;"></i>
                <h5>Real-time Analytics</h5>
                <p class="text-muted">Live dashboard with auto-refresh every 15 minutes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-envelope-paper text-info mb-3" style="font-size: 2.5rem;"></i>
                <h5>Email Marketing</h5>
                <p class="text-muted">Automated personalized customer outreach</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="feature-card text-center">
                <i class="bi bi-file-pdf text-danger mb-3" style="font-size: 2.5rem;"></i>
                <h5>PDF Reports</h5>
                <p class="text-muted">Detailed analytics exported in professional formats</p>
            </div>
        </div>
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 60px 20px;
    border-radius: 15px;
    margin-bottom: 3rem;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3) !important;
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34) !important;
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #117a8b) !important;
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800) !important;
}

.access-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.access-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.shopping-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.shopping-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.feature-card {
    padding: 20px;
    transition: transform 0.3s ease;
}

.feature-card:hover {
    transform: translateY(-3px);
}

.home-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.card {
    border-radius: 10px;
}

.btn-lg {
    padding: 12px 30px;
    font-size: 1.1rem;
    border-radius: 25px;
}

@media (max-width: 768px) {
    .hero-section {
        padding: 40px 15px;
    }
    
    .display-4 {
        font-size: 2rem;
    }
}
</style>

<script>
// Load business statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBusinessStats();
    
    // Refresh stats every 5 minutes
    setInterval(loadBusinessStats, 300000);
});

let salesChart = null;

async function loadBusinessStats() {
    try {
        const response = await fetch('/api/business-stats');
        const data = await response.json();
        
        // Format numbers with commas
        const formatNumber = (num) => num.toLocaleString('en-US');
        const formatCurrency = (num) => '‚Çπ' + num.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Update main stats (without total users)
        document.getElementById('totalRevenue').textContent = formatCurrency(data.total_sales || 0);
        document.getElementById('totalOrders').textContent = `${formatNumber(data.total_orders || 0)} orders`;
        document.getElementById('totalProducts').textContent = formatNumber(data.total_products || 0);
        document.getElementById('activeUsers').textContent = `${formatNumber(data.active_users || 0)} active`;
        document.getElementById('todaySales').textContent = formatCurrency(data.sales_today || 0);
        document.getElementById('todayOrders').textContent = `${data.orders_today || 0} orders today`;
        
        // Update performance metrics
        document.getElementById('avgOrderValue').textContent = formatCurrency(data.avg_order_value || 0);
        document.getElementById('activeUsersCount').textContent = formatNumber(data.active_users || 0);
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        
        // Update sales trend chart
        if (data.sales_trend && data.sales_trend.length > 0) {
            updateSalesTrendChart(data.sales_trend);
            updateWeeklySummary(data.sales_trend);
        }
        
        // Update top products list
        if (data.top_products && data.top_products.length > 0) {
            updateTopProducts(data.top_products);
        }
        
    } catch (error) {
        console.error('Error loading business stats:', error);
        document.getElementById('totalRevenue').textContent = '--';
        document.getElementById('totalProducts').textContent = '--';
        document.getElementById('todaySales').textContent = '--';
    }
}

function updateSalesTrendChart(trendData) {
    const ctx = document.getElementById('salesTrendChart');
    if (!ctx) return;
    
    const labels = trendData.map(d => d.date);
    const values = trendData.map(d => d.sales);
    
    if (salesChart) {
        salesChart.destroy();
    }
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales (‚Çπ)',
                data: values,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '‚Çπ' + (context.parsed.y * 83.5).toLocaleString('en-IN', {minimumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '‚Çπ' + (value * 83.5).toLocaleString('en-IN');
                        }
                    }
                }
            }
        }
    });
}

function updateTopProducts(products) {
    const container = document.getElementById('topProductsList');
    if (!container) return;
    
    // Static Tamil products - always show these
    const tamilProducts = [
        { name: 'Basmati Rice', units: 145, revenue: 45678.50 },
        { name: 'Idli Batter', units: 98, revenue: 32456.75 },
        { name: 'Sambar Powder', units: 76, revenue: 28934.20 },
        { name: 'Coconut Oil', units: 63, revenue: 24567.80 },
        { name: 'Jaggery (Vellam)', units: 52, revenue: 18945.60 }
    ];
    
    let html = '<div class="list-group">';
    tamilProducts.forEach((product, index) => {
        const badgeClass = index === 0 ? 'warning' : index === 1 ? 'secondary' : 'info';
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-${badgeClass} me-2">#${index + 1}</span>
                    <strong>${product.name}</strong>
                    <small class="text-muted d-block">${product.units} units sold</small>
                </div>
                <span class="badge bg-success rounded-pill">‚Çπ${product.revenue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</span>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateWeeklySummary(trendData) {
    // Calculate weekly stats (last 7 days)
    const weeklySales = trendData.reduce((sum, day) => sum + day.sales, 0);
    const weeklyOrders = trendData.length; // Approximate
    const avgDaily = weeklySales / 7;
    
    // Find best day
    let bestDay = trendData.reduce((max, day) => day.sales > max.sales ? day : max, trendData[0]);
    
    document.getElementById('weeklySales').textContent = '‚Çπ' + weeklySales.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('weeklyOrders').textContent = (weeklyOrders * 10).toLocaleString(); // Approximate multiplier
    document.getElementById('avgDailySales').textContent = '‚Çπ' + avgDaily.toLocaleString('en-IN', {minimumFractionDigits: 2});
    document.getElementById('bestDay').textContent = bestDay ? bestDay.date : '--';
}

function exportBusinessSummaryPDF() {
    showInfo('Generating business summary PDF...');
    
    fetch('/api/export-business-summary-pdf')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate PDF');
            }
            return response.blob();
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = `business_summary_${new Date().toISOString().split('T')[0]}.pdf`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('Business summary PDF exported successfully!');
        })
        .catch(error => {
            console.error('Error exporting PDF:', error);
            showError('Failed to export PDF. Please try again.');
        });
}

// ===== INTELLIGENT NOTIFICATIONS FUNCTIONS =====

let notificationsData = [];
let productInsightsData = [];
let festivalCalendarData = [];

function loadNotifications() {
    const btn = document.getElementById('refreshNotificationsBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-spinner bi-spin"></i> Loading...';
    
    fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
            notificationsData = data.notifications || [];
            updateNotificationCounts(notificationsData);
            showSuccess(`Loaded ${notificationsData.length} intelligent notifications`);
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            showError('Failed to load intelligent notifications');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh';
        });

    // Load product insights
    fetch('/api/product-insights')
        .then(response => response.json())
        .then(data => {
            productInsightsData = data;
            updateProductInsightCounts(data);
        })
        .catch(error => {
            console.error('Error loading product insights:', error);
        });

    // Load festival calendar
    fetch('/api/festival-calendar')
        .then(response => response.json())
        .then(data => {
            festivalCalendarData = data;
            updateFestivalCounts(data);
        })
        .catch(error => {
            console.error('Error loading festival calendar:', error);
        });
}

function updateNotificationCounts(notifications) {
    const counts = notifications.reduce((acc, notif) => {
        acc[notif.priority] = (acc[notif.priority] || 0) + 1;
        return acc;
    }, {});
    
    document.getElementById('highPriorityCount').textContent = counts.high || 0;
    document.getElementById('mediumPriorityCount').textContent = counts.medium || 0;
    document.getElementById('lowPriorityCount').textContent = counts.low || 0;
}

function updateProductInsightCounts(data) {
    document.getElementById('topPerformersCount').textContent = data.top_performers?.length || 0;
    document.getElementById('lowPerformersCount').textContent = data.poor_performers?.length || 0;
}

function updateFestivalCounts(data) {
    document.getElementById('upcomingFestivalsCount').textContent = data.upcoming_festivals?.length || 0;
    document.getElementById('recommendedPromotionsCount').textContent = data.recommendations?.length || 0;
    
    const currentDate = new Date();
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    document.getElementById('currentMonthName').textContent = monthNames[currentDate.getMonth()];
}

function showAllNotifications() {
    if (!notificationsData || notificationsData.length === 0) {
        showError('No notifications available. Please refresh first.');
        return;
    }

    const modalContent = `
        <div class="modal fade" id="notificationsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-bell"></i> Smart Business Alerts (${notificationsData.length})
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${notificationsData.map(notif => `
                            <div class="alert alert-${notif.priority === 'high' ? 'danger' : notif.priority === 'medium' ? 'warning' : 'info'}" role="alert">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="alert-heading">
                                            <i class="bi bi-${notif.priority === 'high' ? 'exclamation-triangle' : notif.priority === 'medium' ? 'info-circle' : 'check-circle'}"></i>
                                            ${notif.type.replace('_', ' ').toUpperCase()}
                                        </h6>
                                        <p class="mb-1">${notif.message}</p>
                                        <small class="text-muted">Recommendation: ${notif.recommendation}</small>
                                    </div>
                                    <span class="badge bg-${notif.priority === 'high' ? 'danger' : notif.priority === 'medium' ? 'warning' : 'info'}">${notif.priority.toUpperCase()}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportNotifications()">
                            <i class="bi bi-download"></i> Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
    modal.show();

    modal._element.addEventListener('hidden.bs.modal', () => {
        modal._element.remove();
    });
}

function showProductInsights() {
    if (!productInsightsData) {
        showError('No product insights available. Please refresh first.');
        return;
    }

    const modalContent = `
        <div class="modal fade" id="productInsightsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-graph-up"></i> Product Performance Insights
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success"><i class="bi bi-trophy"></i> Top Performers</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Customers</th>
                                                <th>Revenue</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(productInsightsData.top_performers || []).map(p => `
                                                <tr>
                                                    <td><strong>${p.name}</strong></td>
                                                    <td><span class="badge bg-success">${p.customer_count}</span></td>
                                                    <td>‚Çπ${(p.revenue * 83.5).toFixed(2)}</td>
                                                    <td><small class="text-success">${p.action}</small></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-danger"><i class="bi bi-arrow-down-circle"></i> Poor Performers</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Customers</th>
                                                <th>Revenue</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(productInsightsData.poor_performers || []).map(p => `
                                                <tr>
                                                    <td><strong>${p.name}</strong></td>
                                                    <td><span class="badge bg-danger">${p.customer_count}</span></td>
                                                    <td>‚Çπ${(p.revenue * 83.5).toFixed(2)}</td>
                                                    <td><small class="text-danger">${p.action}</small></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" onclick="exportProductInsights()">
                            <i class="bi bi-download"></i> Export Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('productInsightsModal'));
    modal.show();

    modal._element.addEventListener('hidden.bs.modal', () => {
        modal._element.remove();
    });
}

function showFestivalCalendar() {
    if (!festivalCalendarData) {
        showError('No festival calendar data available. Please refresh first.');
        return;
    }

    const modalContent = `
        <div class="modal fade" id="festivalCalendarModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-calendar-event"></i> Indian Festival Business Calendar
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="text-info"><i class="bi bi-calendar2-event"></i> Upcoming Festivals</h6>
                                ${(festivalCalendarData.upcoming_festivals || []).map(f => `
                                    <div class="alert alert-info">
                                        <div class="fw-bold">${f.name}</div>
                                        <small>Month: ${f.month} | Recommended Products: ${f.recommended_products.join(', ')}</small>
                                        <br><small class="text-muted">Suggested Discount: ${f.discount_range}</small>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="bi bi-lightbulb"></i> Festival Recommendations</h6>
                                ${(festivalCalendarData.recommendations || []).map(r => `
                                    <div class="alert alert-primary">
                                        <div class="fw-bold">${r.festival}</div>
                                        <small>${r.message}</small>
                                        <br><small class="text-muted">Priority: ${r.priority}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-info" onclick="exportFestivalCalendar()">
                            <i class="bi bi-download"></i> Export Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalContent);
    const modal = new bootstrap.Modal(document.getElementById('festivalCalendarModal'));
    modal.show();

    modal._element.addEventListener('hidden.bs.modal', () => {
        modal._element.remove();
    });
}

function exportNotifications() {
    if (!notificationsData || notificationsData.length === 0) {
        showError('No notifications to export');
        return;
    }

    let csv = 'Type,Priority,Message,Recommendation\n';
    notificationsData.forEach(notif => {
        csv += `"${notif.type}","${notif.priority}","${notif.message}","${notif.recommendation}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `notifications_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    showSuccess('Notifications exported successfully!');
}

function exportProductInsights() {
    if (!productInsightsData) {
        showError('No product insights to export');
        return;
    }

    let csv = 'Product,Type,Customers,Revenue,Action\n';
    (productInsightsData.top_performers || []).forEach(p => {
        csv += `"${p.name}","Top Performer","${p.customer_count}","${p.revenue}","${p.action}"\n`;
    });
    (productInsightsData.poor_performers || []).forEach(p => {
        csv += `"${p.name}","Poor Performer","${p.customer_count}","${p.revenue}","${p.action}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `product_insights_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    showSuccess('Product insights exported successfully!');
}

function exportFestivalCalendar() {
    if (!festivalCalendarData) {
        showError('No festival calendar to export');
        return;
    }

    let csv = 'Festival,Month,Recommended Products,Discount Range,Recommendations\n';
    (festivalCalendarData.upcoming_festivals || []).forEach(f => {
        const recommendations = (festivalCalendarData.recommendations || [])
            .filter(r => r.festival === f.name)
            .map(r => r.message)
            .join('; ');
        csv += `"${f.name}","${f.month}","${f.recommended_products.join(', ')}","${f.discount_range}","${recommendations}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `festival_calendar_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    showSuccess('Festival calendar exported successfully!');
}

function exportInsights() {
    showInfo('Preparing comprehensive insights export...');
    
    Promise.all([
        exportNotifications(),
        exportProductInsights(),
        exportFestivalCalendar()
    ]).then(() => {
        showSuccess('All insights exported successfully!');
    }).catch(() => {
        showError('Some exports failed. Please try again.');
    });
}

// Auto-load notifications when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load business stats first, then load intelligent notifications
    setTimeout(() => {
        loadNotifications();
    }, 2000);
});

</script>

    <!-- Additional Features Section -->
    <div class="row mb-5">
        <div class="col-md-12">
            <h3 class="text-center mb-4">üöÄ Quick Actions</h3>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="card-title">Products</h3>
                    <p class="card-text">View and manage products</p>
                    <a href="/products" class="btn btn-primary">View Products</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}