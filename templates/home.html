{% extends "base.html" %}

{% block title %}Sales Sense AI - Home{% endblock %}

{% block content %}
<div class="page-wrapper">

  <!-- BigBasket-style Hero Banner -->
  <div class="hero-section">
    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:12px;">
      <div style="width:52px;height:52px;background:rgba(255,255,255,.25);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.2rem;color:#fff;">SS</div>
      <h1 style="margin:0;">SalesSense AI</h1>
    </div>
    <p class="lead">Your Smart Grocery Intelligence Platform</p>
    <p>Real-time analytics &bull; Festival offers &bull; AI-powered insights</p>
    <div class="mt-4" style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
      <a href="/labor" class="btn btn-light btn-lg">
        <i class="fas fa-shopping-bag"></i> Shop Now
      </a>
      <a href="/analytics" class="btn btn-lg" style="background:rgba(255,255,255,.2);color:#fff;border:2px solid rgba(255,255,255,.5);">
        <i class="fas fa-chart-bar"></i> Analytics
      </a>
    </div>
  </div>

  <!-- Category Quick Links (BigBasket style) -->
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:28px;">
    {% set cats = [('🥦','Vegetables'),('🍎','Fruits'),('🥛','Dairy'),('🍿','Snacks'),('🥤','Beverages'),('🍞','Bakery'),('🧴','Personal'),('🏠','Household')] %}
    {% for emoji, name in cats %}
    <a href="/products?cat={{ name }}" style="background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:14px 8px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:6px;font-weight:600;font-size:.75rem;color:#333;text-decoration:none;" onmouseover="this.style.boxShadow='0 2px 12px rgba(132,194,37,.3)';this.style.borderColor='#84C225'" onmouseout="this.style.boxShadow='0 1px 4px rgba(0,0,0,.06)';this.style.borderColor='#e0e0e0'">
      <span style="font-size:1.8rem;">{{ emoji }}</span>{{ name }}
    </a>
    {% endfor %}
  </div>

  <!-- Real-Time Stats -->
  <div class="row mb-4">
    <div class="col-12 mb-3 text-center">
      <h4 class="fw-bold" style="color:var(--gray-900);">📈 Real-Time Business Overview</h4>
    </div>
    <div class="col-md-4 mb-3">
      <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
        <div class="stat-value" id="totalRevenue">Loading…</div>
        <div class="stat-label">Total Revenue</div>
        <small id="totalOrders" style="opacity:.8;">…</small>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-box"></i></div>
        <div class="stat-value" id="totalProducts">Loading…</div>
        <div class="stat-label">Products</div>
        <small id="activeUsers" style="opacity:.8;">…</small>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
        <div class="stat-value" id="todaySales">Loading…</div>
        <div class="stat-label">Today's Sales</div>
        <small id="todayOrders" style="opacity:.8;">…</small>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header"><i class="fas fa-chart-line"></i> Sales Trend (Last 7 Days)</div>
        <div style="padding:1rem;">
          <canvas id="salesTrendChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header"><i class="fas fa-trophy"></i> Top Selling Products (30 Days)</div>
        <div id="topProductsList" style="padding:1rem;">
          <div class="text-center text-muted">Loading…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Priority Insights -->
  <div class="row mb-4">
    <div class="col-12 mb-2">
      <h4 class="fw-bold" style="color:var(--gray-900);">🏷️ Product Priority Insights</h4>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card" style="border-left:4px solid #16a34a;">
        <div class="card-body" style="padding:1.2rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-size:.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;"><i class="fas fa-arrow-trend-up" style="color:#16a34a;"></i> High Priority</div>
              <div id="homePriorityHigh" style="font-size:1.6rem;font-weight:800;color:#16a34a;margin-top:4px;">—</div>
              <div style="font-size:.75rem;color:#9ca3af;">Top selling products</div>
            </div>
            <div style="width:48px;height:48px;background:#dcfce7;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;">🔥</div>
          </div>
          <div id="homePriorityHighList" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card" style="border-left:4px solid #d97706;">
        <div class="card-body" style="padding:1.2rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-size:.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;"><i class="fas fa-equals" style="color:#d97706;"></i> Medium Priority</div>
              <div id="homePriorityMid" style="font-size:1.6rem;font-weight:800;color:#d97706;margin-top:4px;">—</div>
              <div style="font-size:.75rem;color:#9ca3af;">Average performers</div>
            </div>
            <div style="width:48px;height:48px;background:#fef3c7;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;">📊</div>
          </div>
          <div id="homePriorityMidList" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card" style="border-left:4px solid #b91c1c;">
        <div class="card-body" style="padding:1.2rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-size:.75rem;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.05em;"><i class="fas fa-arrow-trend-down" style="color:#b91c1c;"></i> Low Priority</div>
              <div id="homePriorityLow" style="font-size:1.6rem;font-weight:800;color:#b91c1c;margin-top:4px;">—</div>
              <div style="font-size:.75rem;color:#9ca3af;">Need attention</div>
            </div>
            <div style="width:48px;height:48px;background:#fee2e2;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;">⚠️</div>
          </div>
          <div id="homePriorityLowList" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics -->
  <div class="row mb-4">
    <div class="col-12 mb-3 text-center">
      <h4 class="fw-bold" style="color:var(--gray-900);">📊 Performance Metrics</h4>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-shopping-cart" style="font-size:2.5rem;color:var(--secondary);"></i>
          <h3 id="avgOrderValue" class="mt-3 fw-bold" style="color:var(--gray-900);">₹0.00</h3>
          <p class="text-muted mb-0">Average Order Value</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-users" style="font-size:2.5rem;color:var(--primary);"></i>
          <h3 id="activeUsersCount" class="mt-3 fw-bold" style="color:var(--gray-900);">0</h3>
          <p class="text-muted mb-0">Active Users (30 Days)</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <i class="fas fa-clock" style="font-size:2.5rem;color:var(--info);"></i>
          <h3 id="lastUpdate" class="mt-3 fw-bold" style="color:var(--gray-900);">--:--</h3>
          <p class="text-muted mb-0">Last Updated</p>
        </div>
      </div>
    </div>
  </div>

  <!-- System Access Cards -->
  <div class="row mb-4">
    <div class="col-12 mb-3 text-center">
      <h4 class="fw-bold" style="color:var(--gray-900);">🚀 System Access</h4>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card access-card h-100">
        <div style="padding:2rem;text-align:center;">
          <i class="fas fa-user-shield" style="font-size:3rem;color:var(--primary);margin-bottom:1rem;"></i>
          <h4 class="card-title">Admin Panel</h4>
          <p class="card-text">Complete system management, analytics, and business intelligence</p>
          <ul class="list-unstyled text-start mb-4 mt-3">
            <li>📊 Advanced Analytics</li>
            <li>👥 User Management</li>
            <li>📧 Email Marketing</li>
            <li>🤖 AI Assistant</li>
            <li>📈 Real-time Reports</li>
          </ul>
          <a href="/admin" class="btn btn-primary w-100">Access Admin Panel</a>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card access-card h-100">
        <div style="padding:2rem;text-align:center;">
          <i class="fas fa-users" style="font-size:3rem;color:var(--secondary);margin-bottom:1rem;"></i>
          <h4 class="card-title">Worker Portal</h4>
          <p class="card-text">Streamlined interface for daily operations and product management</p>
          <ul class="list-unstyled text-start mb-4 mt-3">
            <li>📦 Product Management</li>
            <li>📝 Order Processing</li>
            <li>📊 Performance Tracking</li>
            <li>🔔 Task Notifications</li>
            <li>📋 Daily Reports</li>
          </ul>
          <a href="/worker" class="btn btn-secondary w-100">Access Worker Portal</a>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card access-card h-100">
        <div style="padding:2rem;text-align:center;">
          <i class="fas fa-cogs" style="font-size:3rem;color:var(--info);margin-bottom:1rem;"></i>
          <h4 class="card-title">Customer Portal</h4>
          <p class="card-text">Browse products and shop with festival offers &amp; discounts</p>
          <ul class="list-unstyled text-start mb-4 mt-3">
            <li>⏰ Time Tracking</li>
            <li>📊 Productivity Analytics</li>
            <li>👷 Worker Assignments</li>
            <li>📈 Performance Metrics</li>
            <li>💼 Resource Planning</li>
          </ul>
          <a href="/labor" class="btn btn-info w-100">Shop as Customer</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Platform Features -->
  <div class="row mb-2">
    <div class="col-12 mb-3 text-center">
      <h4 class="fw-bold" style="color:var(--gray-900);">✨ Platform Features</h4>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="feature-card">
        <i class="fas fa-robot" style="font-size:2.5rem;color:var(--primary);"></i>
        <h5>AI Assistant</h5>
        <p>Smart chatbot for instant business insights</p>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="feature-card">
        <i class="fas fa-chart-line" style="font-size:2.5rem;color:var(--secondary);"></i>
        <h5>Real-time Analytics</h5>
        <p>Live dashboard with auto-refresh every 15 minutes</p>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="feature-card">
        <i class="fas fa-envelope-open-text" style="font-size:2.5rem;color:var(--info);"></i>
        <h5>Email Marketing</h5>
        <p>Automated personalized customer outreach</p>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="feature-card">
        <i class="fas fa-file-pdf" style="font-size:2.5rem;color:var(--danger);"></i>
        <h5>PDF Reports</h5>
        <p>Detailed analytics in professional formats</p>
      </div>
    </div>
  </div>

</div><!-- /.page-wrapper -->
{% endblock %}

{% block scripts %}
<script>
function formatINR(amount) {
  return '₹' + Number(amount || 0).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2});
}

async function loadBusinessStats() {
  const setEl = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  try {
    const res = await fetch('/api/business-stats?days=7');
    if (!res.ok) throw new Error('API error');
    const d = await res.json();

    setEl('totalRevenue',    formatINR(d.total_sales));
    setEl('totalOrders',     (d.total_orders || 0).toLocaleString() + ' total orders');
    setEl('totalProducts',   d.total_products || 0);
    setEl('activeUsers',     (d.active_users || 0) + ' active users');
    setEl('todaySales',      formatINR(d.sales_today));
    setEl('todayOrders',     (d.orders_today || 0) + ' orders today');
    setEl('avgOrderValue',   formatINR(d.avg_order_value));
    setEl('activeUsersCount',d.active_users || 0);
    setEl('lastUpdate',      new Date().toLocaleTimeString('en-IN'));

    loadTopProducts(d.top_products || []);
    loadSalesTrendChart(d.sales_trend || []);
    loadProductPriority(d.top_products || [], d.top_users || []);
    buildHomePriority(d.top_products || []);
  } catch (e) {
    console.error('Stats load error:', e);
    ['totalRevenue','totalProducts','todaySales'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = 'N/A';
    });
  }
}

function buildHomePriority(products) {
  const total  = products.length;
  if (!total) return;
  const highEnd = Math.ceil(total / 3);
  const midEnd  = Math.ceil(total * 2 / 3);
  const high = products.slice(0, highEnd);
  const mid  = products.slice(highEnd, midEnd);
  const low  = products.slice(midEnd);
  const setEl = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  setEl('homePriorityHigh', high.length + ' Products');
  setEl('homePriorityMid',  mid.length  + ' Products');
  setEl('homePriorityLow',  low.length  + ' Products');
  const fmt = (arr, el) => {
    const e = document.getElementById(el);
    if (!e) return;
    e.innerHTML = arr.slice(0,3).map(p =>
      `<div style="font-size:.75rem;padding:3px 0;border-bottom:1px solid #f0f0f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name || 'Product'}</div>`
    ).join('');
  };
  fmt(high, 'homePriorityHighList');
  fmt(mid,  'homePriorityMidList');
  fmt(low,  'homePriorityLowList');
}

function loadProductPriority(products, topUsers) {
  const total    = products.length;
  const highEnd  = Math.ceil(total / 3);
  const midEnd   = Math.ceil(total * 2 / 3);
  const highCount = highEnd;
  const midCount  = midEnd - highEnd;
  const lowCount  = total - midEnd;
  const setEl = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  setEl('highProdCount', highCount > 0 ? highCount + ' products' : '—');
  setEl('midProdCount',  midCount  > 0 ? midCount  + ' products' : '—');
  setEl('lowProdCount',  lowCount  > 0 ? lowCount  + ' products' : '—');
  if (topUsers.length > 0) {
    const row = document.getElementById('topBuyerRow');
    if (row) row.style.display = '';
    setEl('topBuyerName', (topUsers[0].name || 'Guest') + ' · ' + formatINR(topUsers[0].spent));
  }
}

function loadTopProducts(products) {
  const el = document.getElementById('topProductsList');
  if (!el) return;
  if (!products.length) {
    el.innerHTML = '<p class="text-muted text-center py-3">No sales data available yet.</p>';
    return;
  }
  el.innerHTML = '<div class="list-group">' + products.map((p, i) => {
    const colors = ['warning','secondary','info','primary','success'];
    return `<div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <span class="badge bg-${colors[i]||'primary'} me-2">#${i+1}</span>
        <strong>${p.name||'Unknown'}</strong>
        <small class="text-muted d-block">${p.units||0} units sold</small>
      </div>
      <span class="badge bg-success rounded-pill">${formatINR(p.revenue)}</span>
    </div>`;
  }).join('') + '</div>';
}

function loadSalesTrendChart(trend) {
  const ctx = document.getElementById('salesTrendChart');
  if (!ctx || !trend.length) return;
  if (window._trendChart) window._trendChart.destroy();
  window._trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: trend.map(t => t.date),
      datasets: [{
        label: 'Sales (₹)',
        data: trend.map(t => t.sales),
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79,70,229,.1)',
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#4f46e5',
        pointRadius: 4
      }]
    },
    options: {
      responsive:true, plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true,ticks:{callback:v=>'₹'+v.toLocaleString('en-IN')}}}
    }
  });
}

function exportBusinessSummaryPDF() {
  window.showToast ? window.showToast('PDF export coming soon!','warning') : alert('PDF export coming soon!');
}

async function loadNotifications() {
  // === Smart Alerts ===
  try {
    const nr = await fetch('/api/notifications');
    const nd = await nr.json();
    const notifs = nd.notifications || [];
    const high   = notifs.filter(n => n.priority === 'high').length;
    const medium = notifs.filter(n => n.priority === 'medium').length;
    const low    = notifs.filter(n => n.priority === 'low').length;
    const setEl  = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
    setEl('highPriorityCount',   high);
    setEl('mediumPriorityCount', medium);
    setEl('lowPriorityCount',    low);
  } catch(e) { console.warn('Notifications load error:', e); }

  // === Product Insights ===
  try {
    const pr = await fetch('/api/product-insights');
    const pd = await pr.json();
    const topCount = (pd.top_performers || []).length;
    const el = document.getElementById('topPerformersCount');
    if (el) el.textContent = topCount > 0 ? topCount + ' Products' : 'No data yet';
  } catch(e) { console.warn('Product insights error:', e); }

  // === Festival Calendar ===
  try {
    const fr  = await fetch('/api/festival-calendar');
    const fd  = await fr.json();
    const upcoming = fd.upcoming_festivals || [];
    const fe  = document.getElementById('upcomingFestivalsCount');
    if (fe) fe.textContent = upcoming.length > 0 ? upcoming.length + ' Festivals' : 'None this month';
    const currentMonthEl = document.getElementById('currentMonthName');
    if (currentMonthEl) currentMonthEl.textContent = new Date().toLocaleString('en-IN', {month:'long'});
  } catch(e) { console.warn('Festival calendar error:', e); }
}

function showAllNotifications() { window.location.href = '/admin'; }

document.addEventListener('DOMContentLoaded', () => {
  loadBusinessStats();
  loadNotifications();
});
</script>
{% endblock %}

