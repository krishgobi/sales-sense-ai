{% extends "base.html" %}
{% block title %}Admin Dashboard - Sales Sense AI{% endblock %}

{% block content %}
<div class="page-wrapper" style="padding:1.5rem;">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category == 'error' and 'danger' or category }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- BigBasket-style Dashboard Header -->
  <div class="dashboard-header mb-4" style="background:linear-gradient(135deg,#84C225,#3d7a00);color:white;padding:1.75rem 2rem;border-radius:12px;">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:46px;height:46px;background:rgba(255,255,255,.25);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1rem;color:#fff;flex-shrink:0;">SS</div>
        <div>
          <h1 style="margin:0;font-size:1.6rem;font-weight:800;">Admin Dashboard</h1>
          <p style="margin:.2rem 0 0;opacity:.85;font-size:.85rem;">Real-time business overview &amp; management</p>
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        {% if not demo_mode %}
        <button onclick="testEmail()" class="btn btn-light btn-sm">
          <i class="fas fa-envelope-circle-check"></i> Test Email
        </button>
        <a href="{{ url_for('admin_logout') }}" class="btn btn-light btn-sm">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
        {% else %}
        <span class="badge bg-warning text-dark px-3 py-2">Demo Mode</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="metrics-grid mb-4">
    <div class="stat-card blue">
      <div class="stat-icon"><i class="fas fa-users"></i></div>
      <div class="stat-value">{{ stats.total_users or 0 }}</div>
      <div class="stat-label">Total Users <span style="font-size:.75rem;opacity:.7;">(+{{ stats.new_users_today or 0 }} today)</span></div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon"><i class="fas fa-indian-rupee-sign"></i></div>
      <div class="stat-value">‚Çπ{{ "%.0f"|format(stats.total_sales or 0) }}</div>
      <div class="stat-label">Total Revenue</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
      <div class="stat-value">{{ stats.total_workers or 0 }}</div>
      <div class="stat-label">Workers <span style="font-size:.75rem;opacity:.7;">({{ stats.active_workers or 0 }} active)</span></div>
    </div>
    <div class="stat-card orange">
      <div class="stat-icon"><i class="fas fa-box"></i></div>
      <div class="stat-value">{{ stats.total_products or 0 }}</div>
      <div class="stat-label">Products</div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-3 mb-4">
    <div class="col-auto">
      <a href="#overview" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Overview</a>
    </div>
    <div class="col-auto">
      <a href="#users" class="btn btn-outline"><i class="fas fa-users"></i> Users</a>
    </div>
    <div class="col-auto">
      <a href="#workers" class="btn btn-outline"><i class="fas fa-user-tie"></i> Workers</a>
    </div>
    <div class="col-auto">
      <a href="#products" class="btn btn-outline"><i class="fas fa-box"></i> Products</a>
    </div>
    <div class="col-auto">
      <a href="#email" class="btn btn-outline"><i class="fas fa-envelope"></i> Email</a>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('admin_festival_notifications') }}" class="btn btn-outline">
        <i class="fas fa-calendar-star"></i> Festivals
      </a>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('analytics_page') }}" class="btn btn-primary">
        <i class="fas fa-chart-line"></i> Full Analytics
      </a>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('admin_ai_chat_page') }}"
         class="btn btn-primary btn-sm"
         style="font-weight:700;">
        <i class="fas fa-robot"></i> AI Assistant
      </a>
    </div>
  </div>

  <!-- Overview Section -->
  <section id="overview" class="card mb-4">
    <div class="card-body">
      <h4 class="chart-title mb-3">Business Overview</h4>
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="p-3 rounded" style="background:#e8f5d0;border-left:4px solid #84C225;">
            <div style="font-size:.8rem;color:#3d7a00;">Today's Sales</div>
            <div class="fw-bold fs-5">‚Çπ{{ "%.2f"|format(stats.sales_today or 0) }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 rounded" style="background:#f0fdf4;border-left:4px solid #3d7a00;">
            <div style="font-size:.8rem;color:#3d7a00;">Avg Order Value</div>
            <div class="fw-bold fs-5">‚Çπ{{ "%.2f"|format((stats.total_sales / stats.total_users) if stats.total_users and stats.total_users > 0 else 0) }}</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 rounded" style="background:#fef9f0;border-left:4px solid #ff8c00;">
            <div style="font-size:.8rem;color:#92400e;">Stock Value</div>
            <div class="fw-bold fs-5">‚Çπ{{ "%.2f"|format(product_summary.total_stock_value if product_summary else 0) }}</div>
          </div>
        </div>
      </div>

      <!-- Chart date range controls -->
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
        <span style="font-size:.82rem;font-weight:600;color:#6b7280;">Date Range:</span>
        <input type="date" id="chartFrom" style="border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;font-size:.82rem;">
        <span style="font-size:.82rem;color:#9ca3af;">to</span>
        <input type="date" id="chartTo"   style="border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;font-size:.82rem;">
        <button onclick="applyChartDateRange()" style="background:#4f46e5;color:#fff;border:none;border-radius:6px;padding:5px 14px;font-size:.82rem;cursor:pointer;">
          <i class="fas fa-sync-alt"></i> Apply
        </button>
        <button onclick="resetChartRange()" style="background:#f3f4f6;color:#374151;border:1px solid #e5e7eb;border-radius:6px;padding:5px 12px;font-size:.82rem;cursor:pointer;">Reset</button>
        <span id="chartRangeLabel" style="font-size:.78rem;color:#9ca3af;"></span>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <h5 class="chart-title">Sales Trend</h5>
          <div style="position:relative;height:240px;"><canvas id="salesChart"></canvas></div>
        </div>
        <div class="chart-card">
          <h5 class="chart-title">Revenue by Category</h5>
          <div style="position:relative;height:240px;"><canvas id="categoryChart"></canvas></div>
        </div>
      </div>

      <!-- Top Products Table -->
      <h5 class="chart-title mt-4 mb-3">Top Selling Products</h5>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>#</th><th>Product</th><th>Units Sold</th><th>Revenue</th><th>Performance</th></tr></thead>
          <tbody>
            {% for product in top_products %}
            <tr>
              <td>{{ loop.index }}</td>
              <td><strong>{{ product.name }}</strong></td>
              <td>{{ product.units_sold or product.quantity_sold or 0 }}</td>
              <td>‚Çπ{{ "%.2f"|format(product.revenue) }}</td>
              <td>
                {% set pct = (product.revenue / top_products[0].revenue * 100) if top_products and top_products[0].revenue > 0 else 0 %}
                <div class="progress" style="height:12px;">
                  <div class="progress-bar" style="width:{{ pct }}%;background:var(--primary);">{{ "%.0f"|format(pct) }}%</div>
                </div>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center text-muted py-3">No sales data available. Connect MongoDB to view data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Users Section -->
  <section id="users" class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h4 class="chart-title mb-0">User Management</h4>
        <span class="badge" style="background:var(--primary);padding:.5rem .9rem;font-size:.85rem;">
          Total: {{ pagination.total if pagination else stats.total_users }}
        </span>
      </div>

      <div class="input-group mb-3">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" class="form-control" id="userSearchInput" placeholder="Filter by name, email or phone‚Ä¶" oninput="filterUsers()">
      </div>

      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Joined</th><th>Action</th></tr></thead>
          <tbody id="userTableBody">
            {% for user in recent_users %}
            <tr data-search="{{ (user.name or '') | lower }} {{ (user.email or '') | lower }} {{ (user.phone or '') | lower }}">
              <td><strong>{{ user.name or 'N/A' }}</strong></td>
              <td>{{ user.email or 'N/A' }}</td>
              <td>{{ user.phone or '‚Äî' }}</td>
              <td>{{ user.join_date or '‚Äî' }}</td>
              <td>
                <a href="/admin/user-details/{{ user._id }}" class="btn btn-sm btn-primary">
                  <i class="fas fa-eye"></i> View
                </a>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center text-muted py-3">No users found</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if pagination and pagination.pages > 1 %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
          <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin_dashboard', page=pagination.page-1) }}">‚Üê Prev</a>
          </li>
          {% for p in range(1, pagination.pages + 1) %}
            {% if p == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% elif p <= 2 or p > pagination.pages - 2 or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
              <li class="page-item"><a class="page-link" href="{{ url_for('admin_dashboard', page=p) }}">{{ p }}</a></li>
            {% elif p == 3 or p == pagination.pages - 2 %}
              <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if pagination.page == pagination.pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('admin_dashboard', page=pagination.page+1) }}">Next ‚Üí</a>
          </li>
        </ul>
        <p class="text-center text-muted" style="font-size:.85rem;">
          Showing {{ (pagination.page-1) * pagination.per_page + 1 }}‚Äì{{ [pagination.page * pagination.per_page, pagination.total]|min }} of {{ pagination.total }} users
        </p>
      </nav>
      {% endif %}
    </div>
  </section>

  <!-- Workers Section -->
  <section id="workers" class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h4 class="chart-title mb-0">Workers Management</h4>
        {% if not demo_mode %}
        <button class="btn btn-primary btn-sm" onclick="openAddWorkerModal()">
          <i class="fas fa-user-plus"></i> Add Worker
        </button>
        {% else %}
        <button class="btn btn-primary btn-sm" disabled title="Disabled in demo">
          <i class="fas fa-user-plus"></i> Add Worker
        </button>
        {% endif %}
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Products Added</th><th>Actions</th></tr></thead>
          <tbody>
            {% for worker in workers_summary %}
            <tr>
              <td><strong>{{ worker.name or 'N/A' }}</strong></td>
              <td>{{ worker.email or 'N/A' }}</td>
              <td>{{ worker.phone or '‚Äî' }}</td>
              <td>{{ worker.total_products_added or 0 }}</td>
              <td class="d-flex gap-1 flex-wrap">
                {% if not demo_mode %}
                <button class="btn btn-sm btn-warning" onclick="resetWorkerPassword('{{ worker._id }}')">Reset Pwd</button>
                <button class="btn btn-sm btn-danger"  onclick="deactivateWorker('{{ worker._id }}')">Deactivate</button>
                {% else %}
                <button class="btn btn-sm btn-warning" disabled>Reset Pwd</button>
                <button class="btn btn-sm btn-danger"  disabled>Deactivate</button>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center text-muted py-3">No workers found</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Products Summary Section -->
  <section id="products" class="card mb-4">
    <div class="card-body">
      <h4 class="chart-title mb-3">Product Reports</h4>
      <div class="row g-3">
        {% set ps = product_summary if product_summary else {} %}
        <div class="col-md-4"><div class="card p-3 text-center"><div style="font-size:.8rem;color:var(--text-muted);">Total Products</div><div class="fw-bold fs-4 mt-1">{{ ps.total_products or 0 }}</div></div></div>
        <div class="col-md-4"><div class="card p-3 text-center"><div style="font-size:.8rem;color:var(--text-muted);">Stock Value</div><div class="fw-bold fs-4 mt-1">‚Çπ{{ "%.0f"|format(ps.total_stock_value or 0) }}</div></div></div>
        <div class="col-md-4"><div class="card p-3 text-center"><div style="font-size:.8rem;color:var(--text-muted);">Total Units</div><div class="fw-bold fs-4 mt-1">{{ ps.total_stock_quantity or 0 }}</div></div></div>
      </div>
    </div>
  </section>

  <!-- Email Section -->
  <section id="email" class="card mb-4">
    <div class="card-body">
      <h4 class="chart-title mb-3">Email Marketing</h4>
      <div class="row g-3 mb-4">
        <div class="col-auto">
          {% if not demo_mode %}
          <button class="btn btn-primary" onclick="sendPersonalizedOffers()">
            <i class="fas fa-gift"></i> Send Personalized Offers
          </button>
          {% else %}
          <button class="btn btn-primary" disabled title="Disabled in demo">
            <i class="fas fa-gift"></i> Send Personalized Offers
          </button>
          {% endif %}
        </div>
        <div class="col-auto">
          <a href="{{ url_for('admin_festival_notifications') }}" class="btn btn-outline">
            <i class="fas fa-calendar"></i> Festival Email Campaigns
          </a>
        </div>
      </div>

      <h5 style="font-size:1rem;font-weight:600;margin-bottom:1rem;">Send Custom Email</h5>
      <form id="emailForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" style="font-size:.85rem;font-weight:600;">Recipients</label>
            <select class="form-control" id="recipientType" onchange="toggleCustomRecipients(this.value)">
              <option value="all_users">All Users</option>
              <option value="all_workers">All Workers</option>
              <option value="custom">Custom Recipients</option>
            </select>
          </div>
          <div class="col-md-6" id="customRecipientsDiv" style="display:none;">
            <label class="form-label" style="font-size:.85rem;font-weight:600;">Custom Emails (comma-separated)</label>
            <input type="text" class="form-control" id="customRecipients" placeholder="email1@example.com, email2@example.com">
          </div>
          <div class="col-12">
            <label class="form-label" style="font-size:.85rem;font-weight:600;">Subject</label>
            <input type="text" class="form-control" id="emailSubject" required placeholder="Email subject">
          </div>
          <div class="col-12">
            <label class="form-label" style="font-size:.85rem;font-weight:600;">Message</label>
            <textarea class="form-control" id="emailBody" rows="5" required placeholder="Your message‚Ä¶"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label" style="font-size:.85rem;font-weight:600;">Attachment (optional)</label>
            <input type="file" class="form-control" id="attachment">
          </div>
          <div class="col-12">
            {% if not demo_mode %}
            <button type="submit" class="btn btn-primary" id="emailSendBtn">
              <i class="fas fa-paper-plane"></i> Send Email
            </button>
            {% else %}
            <button type="submit" class="btn btn-primary" disabled>
              <i class="fas fa-paper-plane"></i> Send Email (disabled in demo)
            </button>
            {% endif %}
            <div id="emailStatus" style="margin-top:10px;display:none;padding:10px 14px;border-radius:8px;font-size:.88rem;font-weight:600;"></div>
          </div>
        </div>
      </form>

      <!-- Email Sent History -->
      <div style="margin-top:2rem;">
        <h5 style="font-size:1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;">
          <i class="fas fa-history" style="color:#4f46e5;"></i> Email Sent History
          <button onclick="loadEmailHistory()" style="margin-left:auto;background:none;border:1px solid #e5e7eb;border-radius:6px;padding:4px 10px;font-size:.78rem;color:#6b7280;cursor:pointer;">Refresh</button>
        </h5>
        <div id="emailHistoryWrap">
          <div style="text-align:center;padding:1.5rem;color:#9ca3af;">Loading history‚Ä¶</div>
        </div>
      </div>
    </div>
  </section>

</div><!-- /.page-wrapper -->

<!-- Add Worker Modal -->
<div id="addWorkerOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9000;align-items:center;justify-content:center;">
  <div style="background:white;border-radius:16px;padding:2rem;width:100%;max-width:480px;margin:1rem;position:relative;">
    <button onclick="closeAddWorkerModal()" style="position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:#6b7280;">&times;</button>
    <h3 style="margin:0 0 1.5rem;font-size:1.2rem;font-weight:700;">Add New Worker</h3>
    <form id="addWorkerForm" onsubmit="submitWorkerForm(event)">
      <div class="mb-3">
        <label class="form-label" style="font-weight:600;font-size:.85rem;">Full Name *</label>
        <input type="text" id="workerName" name="name" class="form-control" required placeholder="Worker's full name">
      </div>
      <div class="mb-3">
        <label class="form-label" style="font-weight:600;font-size:.85rem;">Email *</label>
        <input type="email" id="workerEmail" name="email" class="form-control" required placeholder="worker@example.com">
        <small class="text-muted">Login credentials will be sent here</small>
      </div>
      <div class="mb-3">
        <label class="form-label" style="font-weight:600;font-size:.85rem;">Password *</label>
        <input type="password" id="workerPassword" name="password" class="form-control" required placeholder="Create a password">
      </div>
      <div class="mb-3">
        <label class="form-label" style="font-weight:600;font-size:.85rem;">Date of Joining</label>
        <input type="date" id="dateOfJoining" name="date_of_joining" class="form-control">
      </div>
      <div class="d-flex gap-2 justify-content-end">
        <button type="button" onclick="closeAddWorkerModal()" class="btn btn-outline">Cancel</button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i> Add Worker
        </button>
      </div>
    </form>
    <div id="workerFormMessage" class="mt-2"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function filterUsers() {
  const q = document.getElementById('userSearchInput').value.toLowerCase();
  document.querySelectorAll('#userTableBody tr').forEach(row => {
    row.style.display = row.dataset.search && row.dataset.search.includes(q) ? '' : 'none';
  });
}

function toggleCustomRecipients(val) {
  document.getElementById('customRecipientsDiv').style.display = val === 'custom' ? '' : 'none';
}

/* ‚îÄ‚îÄ Worker Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openAddWorkerModal() {
  const el = document.getElementById('addWorkerOverlay');
  el.style.display = 'flex';
}
function closeAddWorkerModal() {
  document.getElementById('addWorkerOverlay').style.display = 'none';
  document.getElementById('addWorkerForm').reset();
  document.getElementById('workerFormMessage').innerHTML = '';
}

function submitWorkerForm(e) {
  e.preventDefault();
  const data = {
    name:             document.getElementById('workerName').value,
    email:            document.getElementById('workerEmail').value,
    password:         document.getElementById('workerPassword').value,
    date_of_joining:  document.getElementById('dateOfJoining').value,
  };
  fetch('/admin/add-worker', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) })
  .then(r => r.json())
  .then(d => {
    const msg = document.getElementById('workerFormMessage');
    if (d.success) {
      msg.innerHTML = '<div class="alert alert-success">‚úÖ ' + (d.message || 'Worker added!') + '</div>';
      setTimeout(() => { closeAddWorkerModal(); location.reload(); }, 2000);
    } else {
      msg.innerHTML = '<div class="alert alert-danger">‚ùå ' + (d.error || 'Failed to add worker') + '</div>';
    }
  })
  .catch(() => {
    document.getElementById('workerFormMessage').innerHTML = '<div class="alert alert-danger">Network error</div>';
  });
}

/* ‚îÄ‚îÄ Worker Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function resetWorkerPassword(workerId) {
  if (!confirm('Send a password reset link to this worker?')) return;
  fetch('/admin/reset-worker-password/' + workerId, { method: 'POST' })
  .then(r => r.json())
  .then(d => alert(d.message || (d.success ? 'Password reset sent!' : 'Failed')));
}
function deactivateWorker(workerId) {
  if (!confirm('Deactivate this worker account?')) return;
  fetch('/admin/deactivate-worker/' + workerId, { method: 'POST' })
  .then(r => r.json())
  .then(d => { alert(d.message || (d.success ? 'Worker deactivated' : 'Failed')); if (d.success) location.reload(); });
}

/* ‚îÄ‚îÄ Email ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function testEmail() {
  fetch('/admin/test-email')
  .then(r => r.json())
  .then(d => alert(d.message || (d.success ? 'Test email sent!' : 'Failed: ' + (d.error || ''))));
}

function sendPersonalizedOffers() {
  if (!confirm('Send personalized offers to all users?')) return;
  fetch('/admin/send-personalized-offers', { method: 'POST' })
  .then(r => r.json())
  .then(d => alert(d.message || (d.success ? 'Emails sent!' : 'Failed')));
}

document.getElementById('emailForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const type       = document.getElementById('recipientType').value;
  const customVal  = document.getElementById('customRecipients').value.trim();
  const subject    = document.getElementById('emailSubject').value.trim();
  const body       = document.getElementById('emailBody').value.trim();
  const statusEl   = document.getElementById('emailStatus');
  const btnEl      = document.getElementById('emailSendBtn');

  // Validate custom recipients
  if (type === 'custom' && !customVal) {
    statusEl.style.display    = 'block';
    statusEl.style.background = '#fef3c7';
    statusEl.style.color      = '#92400e';
    statusEl.textContent      = '‚ö†Ô∏è Please enter at least one email address for Custom Recipients.';
    return;
  }

  // Lock button + show spinner
  if (btnEl) { btnEl.disabled = true; btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Queuing‚Ä¶'; }
  statusEl.style.display    = 'block';
  statusEl.style.background = '#eff6ff';
  statusEl.style.color      = '#1e40af';
  statusEl.innerHTML        = '<i class="fas fa-spinner fa-spin"></i> Connecting to mail server‚Ä¶';

  fetch('/admin/send-custom-email', {
    method:  'POST',
    headers: {'Content-Type': 'application/json'},
    body:    JSON.stringify({
      recipient_type:    type,
      custom_recipients: type === 'custom' ? customVal : '',
      subject, body
    })
  })
  .then(r => r.json())
  .then(d => {
    if (!d.success) {
      // Config / validation error ‚Äì show immediately
      statusEl.style.background = '#fee2e2';
      statusEl.style.color      = '#991b1b';
      statusEl.innerHTML        = '‚ùå ' + (d.message || 'Failed.');
      if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '<i class="fas fa-paper-plane"></i> Send Email'; }
      return;
    }

    const total = d.total || 0;
    statusEl.style.background = '#eff6ff';
    statusEl.style.color      = '#1e40af';
    statusEl.innerHTML        = `<i class="fas fa-paper-plane fa-spin"></i> Sending to ${total} recipient(s)‚Ä¶`;

    // Poll until done
    const jobId = d.job_id;
    const poll  = setInterval(() => {
      fetch(`/api/email-send-status/${jobId}`)
      .then(r => r.json())
      .then(job => {
        // Update live counter
        if (!job.done) {
          statusEl.innerHTML = `<i class="fas fa-paper-plane fa-spin"></i> Sending‚Ä¶ ${job.sent + job.failed}/${job.total} processed (${job.sent} sent)`;
          return;
        }
        clearInterval(poll);
        // Done ‚Äî show final result
        if (job.sent > 0) {
          let msg = `‚úÖ Sent to ${job.sent} recipient(s).`;
          if (job.failed)  msg += ` ${job.failed} failed.`;
          if (d.invalid && d.invalid > 0) {
            msg += `<br><span style="font-weight:400;font-size:.82rem;">‚ö†Ô∏è Skipped ${d.invalid} invalid address(es)` +
                   (d.invalid_emails && d.invalid_emails.length ? ': ' + d.invalid_emails.join(', ') : '') + '</span>';
          }
          if (job.error)  msg += `<br><span style="font-weight:400;font-size:.82rem;color:#b91c1c;">Error: ${job.error}</span>`;
          statusEl.style.background = '#dcfce7';
          statusEl.style.color      = '#166534';
          statusEl.innerHTML        = msg;
          document.getElementById('emailForm').reset();
          document.getElementById('customRecipientsDiv').style.display = 'none';
        } else {
          statusEl.style.background = '#fee2e2';
          statusEl.style.color      = '#991b1b';
          statusEl.innerHTML        = `‚ùå Failed to send. ${job.error || ''}`;
        }
        loadEmailHistory();
        if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '<i class="fas fa-paper-plane"></i> Send Email'; }
      })
      .catch(() => clearInterval(poll));
    }, 1500);
  })
  .catch(() => {
    statusEl.style.background = '#fee2e2';
    statusEl.style.color      = '#991b1b';
    statusEl.textContent      = '‚ùå Network error ‚Äî could not reach server.';
    if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '<i class="fas fa-paper-plane"></i> Send Email'; }
  });
});

/* ‚îÄ‚îÄ Email History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function loadEmailHistory() {
  const wrap = document.getElementById('emailHistoryWrap');
  if (!wrap) return;
  fetch('/api/email-history')
  .then(r => r.json())
  .then(logs => {
    if (!logs.length) {
      wrap.innerHTML = '<div style="text-align:center;padding:1.5rem;color:#9ca3af;">No emails sent yet.</div>';
      return;
    }
    const rows = logs.map(l => {
      const statusColor = l.status === 'sent' ? '#16a34a' : '#b91c1c';
      const statusIcon  = l.status === 'sent' ? '‚úÖ' : '‚ùå';
      const typeLabel   = l.recipient_type === 'all_users' ? 'üë• All Users'
                        : l.recipient_type === 'all_workers' ? 'üë∑ All Workers'
                        : 'üìß Custom';
      return `<tr>
        <td style="padding:8px 12px;font-size:.83rem;color:#6b7280;">${l.sent_at || ''}</td>
        <td style="padding:8px 12px;font-size:.83rem;">${typeLabel}</td>
        <td style="padding:8px 12px;font-size:.83rem;font-weight:600;">${l.subject || ''}</td>
        <td style="padding:8px 12px;font-size:.83rem;text-align:center;">${l.recipient_count || 0}</td>
        <td style="padding:8px 12px;font-size:.83rem;color:${statusColor};">${statusIcon} ${l.status}</td>
        <td style="padding:8px 12px;font-size:.78rem;color:#9ca3af;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l.preview || ''}</td>
      </tr>`;
    }).join('');
    wrap.innerHTML = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:left;">Sent At</th>
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:left;">Recipients</th>
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:left;">Subject</th>
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:center;">Sent Count</th>
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:left;">Status</th>
              <th style="padding:10px 12px;font-size:.78rem;font-weight:700;color:#6b7280;text-align:left;">Preview</th>
            </tr>
          </thead>
          <tbody style="border-bottom:1px solid #e5e7eb;">${rows}</tbody>
        </table>
      </div>`;
  })
  .catch(() => { wrap.innerHTML = '<div style="color:#b91c1c;padding:1rem;">Failed to load history.</div>'; });
}

// Load email history when page loads
loadEmailHistory();

/* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let _salesChart = null;
let _catChart   = null;

// Set default dates: last 30 days
(function initChartDates() {
  const today = new Date();
  const past  = new Date(today); past.setDate(past.getDate() - 29);
  const fmt   = d => d.toISOString().slice(0,10);
  document.getElementById('chartFrom').value = fmt(past);
  document.getElementById('chartTo').value   = fmt(today);
})();

async function loadCharts(fromDate, toDate) {
  try {
    const f = fromDate || document.getElementById('chartFrom').value;
    const t = toDate   || document.getElementById('chartTo').value;
    const res  = await fetch(`/api/chart-data?from=${f}&to=${t}`);
    const data = await res.json();

    const trend = data.sales_trend || [];
    const cats  = data.category_breakdown || [];

    // Update label
    const lbl = document.getElementById('chartRangeLabel');
    if (lbl) lbl.textContent = `Showing ${f} ‚Üí ${t}`;

    // ‚îÄ‚îÄ Sales trend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (_salesChart) { _salesChart.destroy(); _salesChart = null; }
    _salesChart = new Chart(document.getElementById('salesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels:   trend.map(p => p.date || ''),
        datasets: [{ label: 'Revenue (‚Çπ)',
          data:            trend.map(p => p.sales || 0),
          backgroundColor: 'rgba(79,70,229,.7)', borderRadius: 6 }]
      },
      options: { responsive:true, maintainAspectRatio:false,
        plugins: { legend: {display:false} },
        scales:  { y: { beginAtZero:true, ticks:{ callback: v=>'‚Çπ'+v.toLocaleString('en-IN') } } }
      }
    });

    // ‚îÄ‚îÄ Category doughnut ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (_catChart) { _catChart.destroy(); _catChart = null; }
    const catLabels = cats.length ? cats.map(c=>c.name||'Other')    : ['No data'];
    const catValues = cats.length ? cats.map(c=>c.total||c.count||0) : [1];
    _catChart = new Chart(document.getElementById('categoryChart').getContext('2d'), {
      type: 'doughnut',
      data: { labels: catLabels, datasets:[{data:catValues,
        backgroundColor:['#4f46e5','#10b981','#f59e0b','#ef4444','#06b6d4','#8b5cf6','#ec4899','#14b8a6'],
        borderWidth:0}] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
    });
  } catch(e) { console.log('Chart load failed:', e); }
}

function applyChartDateRange() {
  const f = document.getElementById('chartFrom').value;
  const t = document.getElementById('chartTo').value;
  if (!f || !t) { alert('Please select both From and To dates.'); return; }
  if (f > t)    { alert('From date cannot be after To date.');     return; }
  loadCharts(f, t);
}

function resetChartRange() {
  const today = new Date();
  const past  = new Date(today); past.setDate(past.getDate() - 29);
  const fmt   = d => d.toISOString().slice(0,10);
  document.getElementById('chartFrom').value = fmt(past);
  document.getElementById('chartTo').value   = fmt(today);
  loadCharts(fmt(past), fmt(today));
}

loadCharts();

/* ‚îÄ‚îÄ User detail modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function viewUserDetails(userId) {
  window.location.href = '/admin/user-details/' + userId;
}
</script>
{% endblock %}
  
